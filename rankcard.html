<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TEAM CHANCE 카드 (세로형 • 모든기능 • 위치/폰트조절 • 다중 템플릿 • 최종 • ±미세조정)</title>

<style>
  :root{
    /* ================= 카드 비율/크기 ================= */
    --cardH: 720px;
    --ratio: 1.5858;
    --cardW: calc(var(--cardH) / var(--ratio));

    /* ================= 공통 색상 ================= */
    --bg:#0f1118; --panel:#171923; --line:#262b3a; --soft:#2a3145;
    --ink:#fff; --muted:#a7adc0; --card:#111522; --cardLine:#28314a;
    --accent:#6aa8ff; --octo-red:#ff2d55;

    /* ================= 요소 위치(px) ================= */
    --badgeY: 0px;
    --ppY: 0px;
    --nameY: 0px;
    --rankY: 0px;
    --brandY: 0px;
    --socketY: 0px;
    --neonY: 0px;
    --footerY: 0px;

    /* ================= 폰트 크기(px) ================= */
    --nameFont: 30px;
    --rankFont: 24px;
    --brandFont: 18px;
    --footerFont: 14px;
  }

  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg);
    font-family:system-ui,-apple-system,"Noto Sans KR",Segoe UI,Roboto,sans-serif;
    color:var(--ink);
    display:flex; align-items:center; justify-content:center;
    min-height:100vh; padding:14px;
  }
  .wrap{width:var(--cardW); max-width:var(--cardW)}

  /* ============== 컨트롤 패널 ============== */
  .controls{
    background:var(--panel); border:1px solid var(--line); border-radius:16px;
    padding:12px; margin-bottom:12px;
  }
  .controls label{display:block; font-size:13px; color:var(--muted); margin-top:6px}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .row-3{display:grid; grid-template-columns:auto 1fr auto auto; gap:6px; align-items:center}
  .row-2auto{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
  .row-1{display:grid; grid-template-columns:1fr; gap:8px}
  .inline{display:flex; align-items:center; gap:8px}
  .mono{font-variant-numeric:tabular-nums; font-feature-settings:"tnum"}
  .controls input,.controls select,.controls button{
    width:100%; margin-top:6px; background:#10131b; color:#fff;
    border:1px solid var(--soft); border-radius:8px; padding:6px 10px; font-size:14px
  }
  .controls input[type="number"]{text-align:center}
  .btn{cursor:pointer}

  /* ============== 카드 본체 ============== */
  .card{
    position:relative; width:var(--cardW); height:var(--cardH);
    background:var(--card); border:1px solid var(--cardLine); border-radius:22px;
    padding:16px 16px 200px; /* 하단 고정문구와 겹치지 않도록 여백 */
    text-align:center; box-shadow:0 10px 28px rgba(0,0,0,.35);
    overflow:hidden; margin:0 auto;
    background-repeat:no-repeat; background-position:center; background-size:cover;
    color:var(--ink);
  }

  /* 프레임 레이어 */
  .frame{
    position:absolute; inset:0; border-radius:22px; pointer-events:none; z-index:10;
    box-shadow:inset 0 0 0 2px rgba(255,255,255,.18);
  }
  .frame-img{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:fill; border-radius:22px; pointer-events:none; z-index:11; display:none;
  }

  /* 배지 */
  .badge{
    display:inline-block; padding:12px 18px; border-radius:999px; font-weight:800; letter-spacing:.4px;
    border:1px solid rgba(255,255,255,.28);
    margin-top:10px; margin-bottom:25px; font-size:28px;
    background:rgba(0,0,0,.18);
    transform:translateY(var(--badgeY));
  }

  /* 프로필(원형) */
  .pp{
    width:170px; height:170px; border-radius:50%; overflow:hidden;
    border:4px solid var(--accent);
    margin:4px auto 12px;
    position:relative; background:#1a1c24; touch-action:none;
    transform:translateY(var(--ppY));
  }
  .pp img{
    position:absolute; left:0; top:0; width:100%; height:auto;
    user-select:none; cursor:grab; display:none; image-orientation:from-image;
  }
  .placeholder{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:56px; color:#555
  }

  /* 텍스트 블록들 */
  .name{
    font-size:var(--nameFont); font-weight:800; margin:4px 0;
    transform:translateY(var(--nameY))
  }
  .name .octo-tag{
    margin-left:8px; font-size:.72em; font-weight:900; letter-spacing:.8px; color:var(--octo-red); display:none
  }
  .rank{
    font-size:var(--rankFont); font-weight:900; letter-spacing:.8px; display:none; margin-bottom:8px;
    transform:translateY(var(--rankY))
  }
  .brand{
    font-size:var(--brandFont); font-weight:800; margin:6px 0 10px; letter-spacing:.6px; text-transform:uppercase;
    transform:translateY(var(--brandY))
  }

  /* 소켓 */
  .sockets{
    display:grid; justify-content:center; gap:10px; margin-top:6px;
    grid-template-columns:56px; transform:translateY(var(--socketY));
  }
  .sockets.cols2{grid-template-columns:repeat(2,56px)}
  .sockets.cols3{grid-template-columns:repeat(3,56px)}
  .sockets.cols4{grid-template-columns:repeat(2,56px)} /* 4개 이상 2열 */

  .socket{
    width:56px; height:56px; border-radius:12px; background:transparent; border:none;
    color:rgba(255,255,255,.32); display:flex; align-items:center; justify-content:center;
    font-size:22px; cursor:pointer; outline:1px dashed rgba(255,255,255,.18);
  }
  .socket img{width:100%; height:100%; object-fit:contain; border-radius:12px}
  .socket.has-img{outline:none}

  /* 네온 이미지 */
  .neon-image-block{margin-top:16px; transform:translateY(var(--neonY))}
  .neon-image-block img{max-width:80%; height:auto; display:block; margin:0 auto}

  /* 하단 고정 문구 */
  .footer-text{
    position:absolute; bottom:20px; left:0; right:0;
    font-size:var(--footerFont); font-weight:600; line-height:1.3; text-align:center; color:var(--ink); opacity:.9; z-index:2;
    transform:translateY(var(--footerY));
  }

  /* 저장 버튼 */
  .savebtn{
    margin-top:12px; width:100%; padding:12px; border:none; border-radius:12px;
    background:#3b82f6; color:#fff; font-size:16px; font-weight:700; cursor:pointer
  }

  /* 위치/폰트 조절 버튼 그룹 */
  .pos-grid{display:grid; grid-template-columns:1fr 92px 44px 44px 56px; gap:6px; align-items:center}
  .pos-grid small{color:#a7adc0}
  .btn-square{padding:6px 0; text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <!-- ===================== 컨트롤 패널 ===================== -->
  <div class="controls">
    <!-- 이름 / 타이틀 -->
    <label>이름 / 닉네임</label>
    <input id="nameInput" type="text" placeholder="예) CHANCE KIM" />

    <label>타이틀 (미선택 시 카드에서 숨김)</label>
    <select id="rankSelect">
      <option value="">-- 선택 안 함 --</option>
      <option>CORE 600</option>
      <option>CORE 1250</option>
      <option>CORE 2500</option>
      <option>CORE 5000</option>
    </select>

    <!-- 프로필 -->
    <div class="row">
      <div>
        <label>프로필 사진</label>
        <input id="photoInput" type="file" accept="image/*" />
      </div>
      <div>
        <label>프로필 이미지 초기화</label>
        <button id="ppReset" class="btn" type="button">센터로 리셋</button>
      </div>
    </div>

    <!-- 배경: 색/투명도/맞춤/이미지 -->
    <label style="margin-top:8px">카드 배경</label>
    <div class="row">
      <div class="inline">
        <input id="cardBgColor" type="color" value="#111522" />
        <small>배경색</small>
      </div>
      <div class="inline" style="justify-content:space-between">
        <input id="cardBgAlpha" type="range" min="0" max="100" value="100" />
        <small class="mono"><span id="alphaVal">100</span>%</small>
      </div>
    </div>
    <div class="row">
      <select id="bgFit">
        <option value="cover">채우기</option>
        <option value="contain">맞춤</option>
      </select>
      <button id="cardBgImageBtn" class="btn" type="button">🖼️ 배경 이미지 선택</button>
    </div>
    <button id="cardBgImageClear" class="btn" type="button" style="margin-top:6px">🧹 배경 이미지 제거</button>
    <input id="cardBgFile" type="file" accept="image/*" style="display:none" />

    <!-- OCTOPUS 태그 -->
    <label style="display:flex;align-items:center;gap:8px;margin-top:8px">
      <input id="octoToggle" type="checkbox" />
      <span style="font-size:14px;color:#ff8fa3">이름 옆에 <b style="color:#ff2d55">OCTOPUS</b> 표시</span>
    </label>

    <!-- 소켓(파일 추가/삭제) -->
    <div class="row" style="grid-template-columns:1fr 1fr">
      <button id="addSocketFile" class="btn" type="button">🧩 파일로 소켓 추가</button>
      <button id="removeLast" class="btn" type="button">🗑️ 마지막 소켓 삭제</button>
    </div>
    <span id="socketInfo" style="display:block;margin-top:6px;color:#a7adc0">소켓 0개</span>
    <input id="socketFile" type="file" accept="image/*" multiple style="display:none" />

    <!-- 타이틀 프레임 PNG 저장/적용(로컬 저장) -->
    <label style="margin-top:10px">타이틀별 프레임 PNG 업로드(내장 저장)</label>
    <div class="row">
      <button class="btn" type="button" onclick="pickFrame('CORE 600')">📥 CORE 600</button>
      <button class="btn" type="button" onclick="pickFrame('CORE 1250')">📥 CORE 1250</button>
    </div>
    <div class="row">
      <button class="btn" type="button" onclick="pickFrame('CORE 2500')">📥 CORE 2500</button>
      <button class="btn" type="button" onclick="pickFrame('CORE 5000')">📥 CORE 5000</button>
    </div>
    <input id="frameFile" type="file" accept="image/png,image/webp" style="display:none" />
    <button id="clearCurrentFrame" class="btn" type="button" style="margin-top:6px">🧹 현재 타이틀 프레임 제거</button>

    <!-- 네온 문구 이미지 -->
    <label style="margin-top:10px">네온 문구 이미지</label>
    <div class="row">
      <button id="neonPickBtn" class="btn" type="button">✨ 네온 이미지 선택</button>
      <button id="neonClearBtn" class="btn" type="button">🧹 네온 이미지 제거</button>
    </div>
    <input id="neonFile" type="file" accept="image/*" style="display:none" />

    <!-- ============ 요소 위치 조절 (± / 숫자 입력) ============ -->
    <label style="margin-top:10px">요소 위치 조절 (상하 이동, px)</label>
    <div class="pos-grid">
      <small>배지</small>
      <input id="pos-badge" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('badge',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('badge',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('badge')">0</button>
    </div>
    <div class="pos-grid">
      <small>프로필</small>
      <input id="pos-pp" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('pp',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('pp',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('pp')">0</button>
    </div>
    <div class="pos-grid">
      <small>이름</small>
      <input id="pos-name" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('name',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('name',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('name')">0</button>
    </div>
    <div class="pos-grid">
      <small>타이틀</small>
      <input id="pos-rank" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('rank',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('rank',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('rank')">0</button>
    </div>
    <div class="pos-grid">
      <small>브랜드</small>
      <input id="pos-brand" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('brand',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('brand',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('brand')">0</button>
    </div>
    <div class="pos-grid">
      <small>소켓</small>
      <input id="pos-socket" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('socket',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('socket',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('socket')">0</button>
    </div>
    <div class="pos-grid">
      <small>네온</small>
      <input id="pos-neon" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('neon',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('neon',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('neon')">0</button>
    </div>
    <div class="pos-grid">
      <small>하단문구</small>
      <input id="pos-footer" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('footer',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('footer',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('footer')">0</button>
    </div>

    <!-- ============ 폰트 크기(숫자 입력 + ±) ============ -->
    <label style="margin-top:10px">폰트 크기 (px)</label>
    <div class="row-3"><small>이름</small><input type="number" id="nameFont" value="30"/><button class="btn" type="button" onclick="adjFont('nameFont',1)">+</button><button class="btn" type="button" onclick="adjFont('nameFont',-1)">-</button></div>
    <div class="row-3"><small>타이틀</small><input type="number" id="rankFont" value="24"/><button class="btn" type="button" onclick="adjFont('rankFont',1)">+</button><button class="btn" type="button" onclick="adjFont('rankFont',-1)">-</button></div>
    <div class="row-3"><small>브랜드</small><input type="number" id="brandFont" value="18"/><button class="btn" type="button" onclick="adjFont('brandFont',1)">+</button><button class="btn" type="button" onclick="adjFont('brandFont',-1)">-</button></div>
    <div class="row-3"><small>하단문구</small><input type="number" id="footerFont" value="14"/><button class="btn" type="button" onclick="adjFont('footerFont',1)">+</button><button class="btn" type="button" onclick="adjFont('footerFont',-1)">-</button></div>

    <!-- ============ 다중 템플릿 ============ -->
    <label style="margin-top:10px">템플릿</label>
    <div class="row">
      <input id="tplName" placeholder="템플릿 이름 (예: 기본, 옥토버전 등)"/>
      <label class="inline" style="margin-top:0"><input type="checkbox" id="tplIncludeImages" /> 이미지 포함 저장</label>
    </div>
    <div class="row">
      <button id="tplSaveAs" class="btn" type="button">💾 저장(새 이름)</button>
      <button id="tplUpdate" class="btn" type="button">📝 덮어쓰기</button>
    </div>
    <div class="row">
      <select id="tplSelect"></select>
      <button id="tplLoad" class="btn" type="button">📂 불러오기</button>
    </div>
    <div class="row">
      <button id="tplDelete" class="btn" type="button">🗑️ 삭제</button>
      <button id="tplExport" class="btn" type="button">⬇️ 내보내기(JSON)</button>
    </div>
    <div class="row">
      <input id="tplImportFile" type="file" accept="application/json" />
      <button id="tplImport" class="btn" type="button">⬆️ 가져오기(JSON)</button>
    </div>
  </div>

  <!-- ===================== 카드 미리보기 ===================== -->
  <div class="card" id="card" role="img" aria-label="Team Chance 카드">
    <div class="frame" id="frame"></div>
    <img id="frameImg" class="frame-img" alt="" />

    <div class="badge">Congratulations!! 🎉</div>

    <div class="pp" id="ppWrap">
      <img id="ppImg" alt="profile" />
      <div class="placeholder" id="ppPlaceholder">👤</div>
    </div>

    <div class="name">
      <span id="nameText">[이름]</span>
      <span class="octo-tag" id="octoTag">OCTOPUS</span>
    </div>

    <div class="rank" id="rankView"></div>

    <div class="brand">🌟 TEAM CHANCE 🌟</div>

    <div class="sockets" id="sockets"></div>

    <!-- 공백 영역 네온 이미지 -->
    <div class="neon-image-block"><img id="neonImg" alt="neon text" style="display:none" /></div>

    <div class="footer-text">Awaken the Movement 🌊 This is ZiNRAi 🔥</div>
  </div>

  <button class="savebtn" id="saveBtn" type="button">📥 카드 PNG로 저장</button>
</div>

<!-- DOM → PNG 저장 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
/* =========================================================
   유틸/선택자
========================================================= */
const $$=(s)=>document.querySelector(s);
const $all=(s,root=document)=>Array.from(root.querySelectorAll(s));

/* 타이틀 색상 */
const COLORS={ "CORE 600":"#bfbfbf", "CORE 1250":"#4caf50", "CORE 2500":"#2196f3", "CORE 5000":"#ffeb3b" };

/* DOM 캐시 */
const card=$$('#card'), frame=$$('#frame'), frameImg=$$('#frameImg');
const sel=$$('#rankSelect'), nameInput=$$('#nameInput'), nameText=$$('#nameText'), rankView=$$('#rankView');
const ppWrap=$$('#ppWrap'), ppImg=$$('#ppImg'), ppPlaceholder=$$('#ppPlaceholder'), photoInput=$$('#photoInput'), ppReset=$$('#ppReset');

const cardBgColor=$$('#cardBgColor'), cardBgAlpha=$$('#cardBgAlpha'), alphaVal=$$('#alphaVal'), bgFit=$$('#bgFit');
const cardBgImageBtn=$$('#cardBgImageBtn'), cardBgImageClear=$$('#cardBgImageClear'), cardBgFile=$$('#cardBgFile');

const octoToggle=$$('#octoToggle'), octoTag=$$('#octoTag');

const socketsWrap=$$('#sockets'), addSocketFileBtn=$$('#addSocketFile'), socketFile=$$('#socketFile'), removeLastBtn=$$('#removeLast');
const socketInfo=$$('#socketInfo'), saveBtn=$$('#saveBtn');

const frameFile=$$('#frameFile'), clearBtn=$$('#clearCurrentFrame');

const neonPickBtn=$$('#neonPickBtn'), neonClearBtn=$$('#neonClearBtn'), neonFile=$$('#neonFile'), neonImg=$$('#neonImg');

/* 위치 입력 DOM (슬라이더 제거, 숫자 + ± 방식) */
const posIds=['badge','pp','name','rank','brand','socket','neon','footer'];
const posInputs=Object.fromEntries(posIds.map(id=>[id,$$('#pos-'+id)]));

/* 폰트 입력 DOM */
const fontIds=['nameFont','rankFont','brandFont','footerFont'];
const fontInputs=Object.fromEntries(fontIds.map(id=>[id,$$('#'+id)]));

/* =========================================================
   배경: 색/투명도/이미지/맞춤 + 가독성 보정
========================================================= */
function hexToRgb(hex){hex=hex.replace('#','');if(hex.length===3)hex=hex.split('').map(h=>h+h).join('');const n=parseInt(hex,16);return{r:(n>>16)&255,g:(n>>8)&255,b:n&255};}
function applyCardBg(){
  const {r,g,b}=hexToRgb(cardBgColor.value);
  const a=Number(cardBgAlpha.value)/100;
  card.style.backgroundColor=`rgba(${r},${g},${b},${a})`;
  alphaVal.textContent=cardBgAlpha.value;

  /* 간단 휘도 추정으로 텍스트 컬러 반전(밝으면 어둡게) */
  const relLum=(0.2126*(r/255)**2.2 + 0.7152*(g/255)**2.2 + 0.0722*(b/255)**2.2) * a;
  card.style.color=(relLum>0.4)?'#111':'#fff';
}
cardBgColor.addEventListener('input',applyCardBg);
cardBgAlpha.addEventListener('input',applyCardBg);
bgFit.addEventListener('change',e=>{ card.style.backgroundSize=e.target.value; });
cardBgImageBtn.onclick=()=>cardBgFile.click();
cardBgFile.addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ card.style.backgroundImage=`url(${ev.target.result})`; card.style.backgroundSize=bgFit.value; };
  r.readAsDataURL(f); cardBgFile.value="";
});
cardBgImageClear.onclick=()=>{ card.style.backgroundImage=''; };

/* =========================================================
   타이틀 프레임 저장/적용 (localStorage)
========================================================= */
function frameKey(title){return'frame_'+title;}
function getFrame(title){return localStorage.getItem(frameKey(title))||"";}
function setFrame(title,dataUrl){localStorage.setItem(frameKey(title),dataUrl);}
function clearFrame(title){localStorage.removeItem(frameKey(title));}

let currentFrameTitle="";
function pickFrame(title){currentFrameTitle=title; frameFile.click(); }
frameFile.addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    setFrame(currentFrameTitle, ev.target.result);
    alert(currentFrameTitle+" 프레임 저장 완료");
    if(sel.value===currentFrameTitle) applyTitle(sel.value);
  };
  reader.readAsDataURL(f);
  frameFile.value="";
});
clearBtn.addEventListener('click',()=>{
  if(!sel.value){ alert('먼저 타이틀을 선택하세요.'); return; }
  clearFrame(sel.value); applyTitle(sel.value);
});

function applyTitle(title){
  if(title){
    rankView.style.display='block';
    const accent=COLORS[title]||"#6aa8ff";
    rankView.innerHTML=`<span style="color:${accent}">★ ${title}</span>`;
    document.querySelector('.pp').style.borderColor=accent;
  }else{
    rankView.style.display='none'; rankView.innerHTML='';
    document.querySelector('.pp').style.borderColor='var(--accent)';
  }
  /* 프레임 레이어 */
  const data=getFrame(title);
  if(data){ frame.style.boxShadow='none'; frameImg.src=data; frameImg.style.display='block'; }
  else { frameImg.removeAttribute('src'); frameImg.style.display='none'; frame.style.boxShadow='inset 0 0 0 2px rgba(255,255,255,.18)'; }
}
sel.addEventListener('change',()=>applyTitle(sel.value));

/* =========================================================
   이름 / OCTOPUS
========================================================= */
nameInput.addEventListener('input',()=>{ nameText.textContent=nameInput.value||"[이름]"; });
octoToggle.addEventListener('change',()=>{ octoTag.style.display=octoToggle.checked?'inline-block':'none'; });

/* =========================================================
   프로필: cover-fit + 제스처
========================================================= */
let imgState={naturalW:0,naturalH:0,baseW:0,baseH:0,scale:1,x:0,y:0,dragging:false,startX:0,startY:0,pinch:false,pinchD0:0,scale0:1};

function coverFit(){
  const cw=ppWrap.clientWidth, ch=ppWrap.clientHeight, iw=imgState.naturalW, ih=imgState.naturalH;
  if(!iw||!ih) return;
  if(iw/ih>=cw/ch){ imgState.baseH=ch; imgState.baseW=ch*iw/ih; }
  else{ imgState.baseW=cw; imgState.baseH=cw*ih/iw; }
  imgState.scale=1; imgState.x=(cw-imgState.baseW)/2; imgState.y=(ch-imgState.baseH)/2; applyImgStyle();
}
function clamp(v,min,max){return Math.min(max,Math.max(min,v));}
function applyImgStyle(){
  const w=imgState.baseW*imgState.scale, h=imgState.baseH*imgState.scale;
  const cw=ppWrap.clientWidth, ch=ppWrap.clientHeight;
  const minX=cw-w, maxX=0, minY=ch-h, maxY=0;
  imgState.x=(w>=cw)?clamp(imgState.x,minX,maxX):(cw-w)/2;
  imgState.y=(h>=ch)?clamp(imgState.y,minY,maxY):(ch-h)/2;
  ppImg.style.width=w+'px'; ppImg.style.height=h+'px';
  ppImg.style.left=imgState.x+'px'; ppImg.style.top=imgState.y+'px';
}
/* 휠 줌(데스크탑) */
ppWrap.addEventListener('wheel', e=>{
  e.preventDefault();
  const factor=(e.deltaY<0)?1.08:0.92;
  const old=imgState.scale, neu=clamp(old*factor,1,5);
  const rect=ppWrap.getBoundingClientRect(), cx=e.clientX-rect.left, cy=e.clientY-rect.top;
  const w0=imgState.baseW*old, h0=imgState.baseH*old, w1=imgState.baseW*neu, h1=imgState.baseH*neu;
  const dx=(cx-imgState.x)/w0, dy=(cy-imgState.y)/h0;
  imgState.x=cx-dx*w1; imgState.y=cy-dy*h1; imgState.scale=neu; applyImgStyle();
},{passive:false});
/* 드래그(데스크탑) */
ppWrap.addEventListener('pointerdown', e=>{
  if(e.pointerType && e.pointerType!=='mouse') return;
  e.preventDefault(); ppWrap.setPointerCapture(e.pointerId);
  imgState.dragging=true; imgState.startX=e.clientX-imgState.x; imgState.startY=e.clientY-imgState.y;
});
ppWrap.addEventListener('pointermove', e=>{
  if(e.pointerType && e.pointerType!=='mouse') return;
  if(!imgState.dragging) return;
  imgState.x=e.clientX-imgState.startX; imgState.y=e.clientY-imgState.startY; applyImgStyle();
});
ppWrap.addEventListener('pointerup',   e=>{ if(e.pointerType && e.pointerType!=='mouse') return; imgState.dragging=false; });
ppWrap.addEventListener('pointercancel',e=>{ if(e.pointerType && e.pointerType!=='mouse') return; imgState.dragging=false; });
/* 모바일: 한손 드래그 + 두손 핀치줌 */
function touchDistance(t){const dx=t[0].clientX-t[1].clientX, dy=t[0].clientY-t[1].clientY; return Math.hypot(dx,dy);}
function touchCenter(t){return{x:(t[0].clientX+t[1].clientX)/2,y:(t[0].clientY+t[1].clientY)/2};}
ppWrap.addEventListener('touchstart', e=>{
  if(e.touches.length===1){
    e.preventDefault(); imgState.dragging=true;
    imgState.startX=e.touches[0].clientX-imgState.x; imgState.startY=e.touches[0].clientY-imgState.y;
  }else if(e.touches.length===2){
    e.preventDefault(); imgState.pinch=true; imgState.pinchD0=touchDistance(e.touches); imgState.scale0=imgState.scale; imgState.center0=touchCenter(e.touches);
  }
},{passive:false});
ppWrap.addEventListener('touchmove', e=>{
  if(e.touches.length===1 && imgState.dragging){
    e.preventDefault(); imgState.x=e.touches[0].clientX-imgState.startX; imgState.y=e.touches[0].clientY-imgState.startY; applyImgStyle();
  }else if(e.touches.length===2 && imgState.pinch){
    e.preventDefault();
    const d=touchDistance(e.touches); let neu=clamp(imgState.scale0*(d/imgState.pinchD0),1,5);
    const rect=ppWrap.getBoundingClientRect();
    const cNow=touchCenter(e.touches); const cx=cNow.x-rect.left, cy=cNow.y-rect.top;
    const old=imgState.scale, w0=imgState.baseW*old, h0=imgState.baseH*old, w1=imgState.baseW*neu, h1=imgState.baseH*neu;
    const dx=(cx-imgState.x)/w0, dy=(cy-imgState.y)/h0;
    imgState.x=cx-dx*w1; imgState.y=cy-dy*h1; imgState.scale=neu; applyImgStyle();
  }
},{passive:false});
ppWrap.addEventListener('touchend', e=>{
  if(e.touches.length===0){ imgState.dragging=false; imgState.pinch=false; }
  if(e.touches.length===1){ imgState.pinch=false; }
});
/* 업로드 → coverFit */
photoInput.addEventListener('change',e=>{
  const f=e.target.files?.[0];
  if(!f){ ppImg.style.display='none'; ppImg.src=''; ppPlaceholder.style.display='flex'; return; }
  const r=new FileReader();
  r.onload=ev=>{
    ppImg.src=ev.target.result;
    ppImg.onload=()=>{ ppImg.style.display='block'; ppPlaceholder.style.display='none';
      imgState.naturalW=ppImg.naturalWidth; imgState.naturalH=ppImg.naturalHeight; coverFit(); };
  };
  r.readAsDataURL(f);
});
ppReset.addEventListener('click',()=>{ if(ppImg.src) coverFit(); });

/* =========================================================
   소켓: 파일 추가/삭제 + 레이아웃 자동
========================================================= */
function updateSocketLayout(){
  const n=$all('.socket',socketsWrap).length;
  socketsWrap.classList.remove('cols2','cols3','cols4');
  if(n===2) socketsWrap.classList.add('cols2');
  else if(n===3) socketsWrap.classList.add('cols3');
  else if(n>=4) socketsWrap.classList.add('cols4');
  socketInfo.textContent=`소켓 ${n}개`;
}
function addSocket(src){
  const el=document.createElement('div');
  el.className='socket has-img';
  el.innerHTML=`<img src="${src}" alt="socket">`;
  socketsWrap.appendChild(el);
  updateSocketLayout();
}
addSocketFileBtn.addEventListener('click',()=>socketFile.click());
socketFile.addEventListener('change',e=>{
  const files=Array.from(e.target.files||[]).filter(f=>f.type.startsWith('image/'));
  if(!files.length) return;
  files.forEach(file=>{
    const reader=new FileReader();
    reader.onload=ev=>addSocket(ev.target.result);
    reader.readAsDataURL(file);
  });
  socketFile.value="";
});
removeLastBtn.addEventListener('click',()=>{
  const items=$all('.socket',socketsWrap);
  if(!items.length){ alert('삭제할 소켓이 없습니다.'); return; }
  items[items.length-1].remove();
  updateSocketLayout();
});

/* =========================================================
   네온 이미지(공백 영역)
========================================================= */
neonPickBtn.addEventListener('click',()=>neonFile.click());
neonFile.addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ neonImg.src=ev.target.result; neonImg.style.display='block'; };
  r.readAsDataURL(f); neonFile.value="";
});
neonClearBtn.addEventListener('click',()=>{ neonImg.removeAttribute('src'); neonImg.style.display='none'; });

/* =========================================================
   PNG 저장
========================================================= */
async function saveCard(){
  await new Promise(r=>requestAnimationFrame(r));
  const canvas=await html2canvas(card,{backgroundColor:null,scale:3,scrollX:0,scrollY:0,useCORS:true});
  const a=document.createElement('a');
  const t=sel.value?`_${sel.value}`:''; const n=(nameText.textContent||'card').replace(/\s+/g,'_');
  a.download=`${n}${t}.png`; a.href=canvas.toDataURL(); a.click();
}
saveBtn.addEventListener('click',saveCard);

/* =========================================================
   위치 조절 (± / 숫자 입력)  ★ 슬라이더 삭제 버전
========================================================= */
function setPos(id, px){
  if(!Number.isFinite(px)) return;
  px = Math.round(px);
  document.documentElement.style.setProperty('--'+id+'Y', px+'px');
  posInputs[id].value = px;
}
function adjPos(id, delta){
  const v=parseInt(posInputs[id].value||'0',10) || 0;
  setPos(id, v+delta);
}
function zeroPos(id){ setPos(id, 0); }
/* 숫자 입력 → 즉시 반영 */
posIds.forEach(id=>{
  posInputs[id].addEventListener('input', ()=>{
    const v=parseInt(posInputs[id].value||'0',10) || 0;
    setPos(id, v);
  });
});

/* =========================================================
   폰트 크기 — 숫자 입력 + ± 버튼
========================================================= */
function setFontVar(id,px){
  if(!Number.isFinite(px)) return;
  if(px<6) px=6;
  document.documentElement.style.setProperty('--'+id, px+'px');
  fontInputs[id].value = px;
}
function adjFont(id,delta){
  const v=parseInt(fontInputs[id].value||0)||0;
  setFontVar(id, v+delta);
}
/* 입력창 직접 입력 반영 */
fontIds.forEach(id=>{
  fontInputs[id].addEventListener('input',()=>{
    const v=parseInt(fontInputs[id].value||0)||0;
    setFontVar(id, v);
  });
});

/* =========================================================
   다중 템플릿 관리 (localStorage.cardTemplates)
========================================================= */
const tplName=$$('#tplName'), tplIncludeImages=$$('#tplIncludeImages');
const tplSaveAs=$$('#tplSaveAs'), tplUpdate=$$('#tplUpdate');
const tplSelect=$$('#tplSelect'), tplLoad=$$('#tplLoad');
const tplDelete=$$('#tplDelete'), tplExport=$$('#tplExport');
const tplImportFile=$$('#tplImportFile'), tplImport=$$('#tplImport');

function getTemplates(){
  try{ return JSON.parse(localStorage.getItem('cardTemplates')||'{}'); }catch(e){ return {}; }
}
function setTemplates(obj){
  localStorage.setItem('cardTemplates', JSON.stringify(obj));
}
function refreshTplSelect(){
  const tpls=getTemplates();
  const names=Object.keys(tpls).sort();
  tplSelect.innerHTML=names.length? names.map(n=>`<option>${n}</option>`).join('') : '<option value="">(저장된 템플릿 없음)</option>';
}

/* 현재 UI 상태 → TemplateObject */
function collectTemplate(includeImages){
  const positions=Object.fromEntries(posIds.map(id=>[id+'Y', String(parseInt(posInputs[id].value||'0',10)||0)]));
  const fonts=Object.fromEntries(fontIds.map(fid=>[fid, String(parseInt(fontInputs[fid].value||'0',10)||0)]));
  const tpl={
    name: tplName.value.trim() || '',
    title: sel.value || '',
    octo: !!octoToggle.checked,
    nameText: nameInput.value || '',
    bgColor: cardBgColor.value,
    bgAlpha: String(cardBgAlpha.value),
    bgFit: bgFit.value,
    positions, fonts
  };

  if(includeImages){
    /* 배경 이미지 dataURL 추출 */
    const bg = getComputedStyle(card).backgroundImage;
    const m = bg && bg.startsWith('url(') ? bg.match(/^url\("(.*)"\)$/) : null;
    if(m && m[1] && m[1].startsWith('data:')) tpl.bgImage = m[1];

    /* 소켓 이미지들 */
    const sockets = $all('.socket img',socketsWrap).map(img=>img.src).filter(Boolean);
    if(sockets.length) tpl.sockets = sockets;

    /* 네온 이미지 */
    if(neonImg && neonImg.src) tpl.neon = neonImg.src;
  }
  return tpl;
}

/* TemplateObject → UI 반영 */
function applyTemplate(tpl){
  /* 텍스트/타이틀/태그 */
  nameInput.value = tpl.nameText || '';
  nameText.textContent = tpl.nameText || '[이름]';
  sel.value = tpl.title || '';
  applyTitle(sel.value);
  octoToggle.checked = !!tpl.octo;
  octoTag.style.display = tpl.octo ? 'inline-block' : 'none';

  /* 배경 */
  cardBgColor.value = tpl.bgColor || '#111522';
  cardBgAlpha.value = tpl.bgAlpha || '100';
  applyCardBg();
  bgFit.value = tpl.bgFit || 'cover';
  card.style.backgroundSize = bgFit.value;

  /* 배경 이미지 복원 */
  card.style.backgroundImage = '';
  if(tpl.bgImage){ card.style.backgroundImage = `url(${tpl.bgImage})`; }

  /* 위치 값 반영 */
  if(tpl.positions){
    posIds.forEach(id=>{
      const v = parseInt(tpl.positions[id+'Y'] ?? '0',10) || 0;
      setPos(id, v);
    });
  }else{
    posIds.forEach(id=>setPos(id,0));
  }

  /* 폰트 크기 */
  if(tpl.fonts){
    fontIds.forEach(fid=>{
      const v = parseInt(tpl.fonts[fid]||0,10) || parseInt(getComputedStyle(document.documentElement).getPropertyValue('--'+fid)) || 12;
      setFontVar(fid, v);
    });
  }

  /* 소켓/네온 (이미지 포함 저장 시) */
  $all('.socket',socketsWrap).forEach(n=>n.remove());
  if(Array.isArray(tpl.sockets)){ tpl.sockets.forEach(src=>addSocket(src)); }
  if(tpl.neon){ neonImg.src = tpl.neon; neonImg.style.display = 'block'; } else { neonImg.removeAttribute('src'); neonImg.style.display='none'; }
}

/* 템플릿 저장(새 이름) */
tplSaveAs.addEventListener('click',()=>{
  const name = (tplName.value||'').trim();
  if(!name){ alert('템플릿 이름을 입력하세요.'); return; }
  const includeImages = tplIncludeImages.checked;
  const tpls=getTemplates();
  if(tpls[name] && !confirm('같은 이름의 템플릿이 있습니다. 덮어쓸까요?')) return;
  tpls[name] = collectTemplate(includeImages);
  tpls[name].name = name;
  setTemplates(tpls);
  refreshTplSelect();
  alert('템플릿 저장 완료!');
});

/* 현재 선택 템플릿에 덮어쓰기 */
tplUpdate.addEventListener('click',()=>{
  const selName = tplSelect.value;
  if(!selName){ alert('왼쪽 드롭다운에서 템플릿을 선택하세요.'); return; }
  const includeImages = tplIncludeImages.checked;
  const tpls=getTemplates();
  tpls[selName] = collectTemplate(includeImages);
  tpls[selName].name = selName;
  setTemplates(tpls);
  alert('덮어쓰기 완료!');
});

/* 불러오기 */
tplLoad.addEventListener('click',()=>{
  const selName = tplSelect.value;
  if(!selName){ alert('불러올 템플릿을 선택하세요.'); return; }
  const tpls=getTemplates();
  const tpl = tpls[selName];
  if(!tpl){ alert('템플릿을 찾을 수 없습니다.'); return; }
  tplName.value = tpl.name || selName;
  applyTemplate(tpl);
});

/* 삭제 */
tplDelete.addEventListener('click',()=>{
  const selName = tplSelect.value;
  if(!selName){ alert('삭제할 템플릿을 선택하세요.'); return; }
  if(!confirm(`템플릿 "${selName}"을(를) 삭제할까요?`)) return;
  const tpls=getTemplates();
  delete tpls[selName];
  setTemplates(tpls);
  refreshTplSelect();
  alert('삭제 완료');
});

/* 내보내기(JSON) */
tplExport.addEventListener('click',()=>{
  const tpls=getTemplates();
  const blob=new Blob([JSON.stringify(tpls,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='cardTemplates.json'; a.click();
  URL.revokeObjectURL(url);
});

/* 가져오기(JSON) — 병합 저장 */
tplImport.addEventListener('click',()=>{
  const f=tplImportFile.files?.[0];
  if(!f){ alert('JSON 파일을 선택하세요.'); return; }
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const incoming=JSON.parse(ev.target.result);
      const base=getTemplates();
      const merged={...base, ...incoming};
      setTemplates(merged);
      refreshTplSelect();
      alert('가져오기 완료!');
    }catch(err){ alert('JSON 파싱 실패: '+err.message); }
  };
  r.readAsText(f);
});

/* =========================================================
   초기화
========================================================= */
(function init(){
  applyCardBg();
  card.style.backgroundImage='';
  card.style.backgroundSize=bgFit.value;
  octoTag.style.display='none';
  nameText.textContent='[이름]';
  applyTitle("");

  /* 위치 입력 초기값 반영 */
  posIds.forEach(id=>{
    const v=parseInt(posInputs[id].value||'0',10)||0;
    setPos(id, v);
  });

  /* 폰트 입력값 → CSS 변수 동기화 */
  fontIds.forEach(fid=>{
    const v=parseInt(fontInputs[fid].value||0)||0;
    setFontVar(fid, v);
  });

  /* 템플릿 목록 로딩 */
  refreshTplSelect();
})();
</script>
</body>
</html>