<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TEAM CHANCE RANK GENERATER</title>

<style>
  :root{
    --cardH:720px; --ratio:1.5858; --cardW:calc(var(--cardH)/var(--ratio));

    /* ===== ìƒ‰/í…Œë§ˆ íŒ”ë ˆíŠ¸ ===== */
    --bg:#060811; --panel:#0a0f1c; --panel2:#0b1222; --line:#19243a; --soft:#273454;
    --ink:#eaf1ff; --muted:#9aa6c8; --accent:#63e3ff; --octo-red:#ff2d55;

    /* ì¹´ë“œ ë°”íƒ•/í…Œë‘ë¦¬ */
    --card:#0a0e16; --cardLine:#1e2a44;

    /* ===== ì´ˆê¸° ìœ„ì¹˜/í°íŠ¸ ê¸°ë³¸ê°’ (ì„¸ë°€ì¡°ì •ê³¼ ì—°ê²°) ===== */
    --badgeY:0px;  /* ë°°ì§€     â†” #pos-badge-num    */
    --ppY:7px;     /* í”„ë¡œí•„   â†” #pos-pp-num       */
    --nameY:6px;   /* ì´ë¦„     â†” #pos-name-num     */
    --rankY:7px;   /* íƒ€ì´í‹€   â†” #pos-rank-num     */
    --brandY:11px; /* ë¸Œëœë“œ   â†” #pos-brand-num    */
    --socketY:32px;/* ì†Œì¼“     â†” #pos-socket-num   */
    --neonY:-25px; /* ë„¤ì˜¨     â†” #pos-neon-num     */
    --footerY:-5px;/* í•˜ë‹¨ë¬¸êµ¬ â†” #pos-footer-num   */

    --nameFont:30px;   /* ì´ë¦„ í°íŠ¸     â†” #font-nameFont-num   */
    --rankFont:24px;   /* íƒ€ì´í‹€ í°íŠ¸   â†” #font-rankFont-num   */
    --brandFont:18px;  /* ë¸Œëœë“œ í°íŠ¸   â†” #font-brandFont-num  */
    --footerFont:14px; /* í•˜ë‹¨ë¬¸êµ¬ í°íŠ¸ â†” #font-footerFont-num */

    /* ì„¸ë°€ì¡°ì • UI í­ */
    --labelW:120px; --numW:86px; --btnW:38px;
  }

  *{box-sizing:border-box}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,"Noto Sans KR",Segoe UI,Roboto,sans-serif;
    min-height:100vh; padding:20px;
    display:flex; justify-content:center; align-items:flex-start;

    /* ìš°ì£¼/ë„¤ë·¸ë¼ ë°°ê²½ */
    background:
      radial-gradient(1100px 700px at 80% -10%, #13203a 0%, transparent 60%),
      radial-gradient(900px 600px at -10% 20%, #111b34 0%, transparent 55%),
      linear-gradient(180deg, #050912 0%, #060811 100%);
    position:relative; overflow-x:hidden;
  }
  body::before, body::after{
    content:""; position:fixed; inset:-10% -10%; pointer-events:none; z-index:-1;
  }
  body::before{
    background:
      radial-gradient(60% 50% at 70% 10%, rgba(121,67,255,.25), transparent 60%),
      radial-gradient(45% 40% at 20% 20%, rgba(99,227,255,.18), transparent 60%);
    filter:blur(18px); opacity:.65; animation:nebula 16s ease-in-out infinite alternate;
  }
  body::after{
    background-image:
      radial-gradient(#ffffff 0.75px, transparent 0.75px),
      radial-gradient(#b7d6ff 0.6px, transparent 0.6px),
      radial-gradient(#ffffff 1px, transparent 1px);
    background-size: 2px 2px, 3px 3px, 1px 1px;
    background-position: 0 0, 25px 40px, 60px 90px;
    opacity:.18; animation:twinkle 12s linear infinite;
  }
  @keyframes nebula { from{transform:translate3d(0,0,0)} to{transform:translate3d(-2%,1%,0)} }
  @keyframes twinkle { from{transform:translateY(0)} to{transform:translateY(-1%)} }

  .wrap{ width:min(980px, 96vw); display:grid; grid-template-columns:1.05fr .95fr; gap:16px; }
  @media (max-width:980px){ .wrap{grid-template-columns:1fr; gap:14px} }

  /* í—¤ë”/ì €ì¥ ë²„íŠ¼ */
  .app-title{ grid-column:1 / -1; display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
  .brandmark{
    font-weight:900; letter-spacing:.7px; margin:0;
    background:linear-gradient(90deg,#63e3ff 0%,#be8cff 50%,#63e3ff 100%);
    -webkit-background-clip:text;background-clip:text;color:transparent;
    text-shadow:0 0 28px rgba(99,227,255,.35);
    font-size:20px;
  }
  .savebtn{
    padding:12px 16px; border:none; border-radius:12px; font-weight:900; letter-spacing:.3px; cursor:pointer;
    color:#041018; background-image:linear-gradient(90deg, #63e3ff, #be8cff);
    box-shadow:0 10px 24px rgba(99,227,255,.25);
  }
  .savebtn:active{ transform:translateY(1px) }

  /* íŒ¨ë„ */
  .controls{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0) 18%), var(--panel);
    border:1px solid var(--line); border-radius:16px; padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
  }
  .canvas{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0) 18%), var(--panel2);
    border:1px solid var(--line); border-radius:16px; padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05), 0 0 80px rgba(99,227,255,.12);
  }

  /* í¼ ê³µí†µ */
  .controls label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  .controls input,.controls select,.controls button{
    width:100%; border-radius:10px; border:1px solid var(--soft); color:#fff;
    background:linear-gradient(180deg, #0d1422, #0a111d);
    padding:11px 12px; font-size:15px; outline:none;
    transition: box-shadow .2s ease, border-color .2s ease;
  }
  .controls input:focus,.controls select:focus{ border-color:#2f8ab3; box-shadow:0 0 0 2px rgba(99,227,255,.25); }
  .row{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px}
  .row-2auto{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:end}
  .inline{display:flex; align-items:center; gap:10px}
  .nowrap{white-space:nowrap}

  .block{border:1px solid var(--line); border-radius:12px; padding:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0) 16%), #0c1220; margin-bottom:12px}
  .block h3{margin:0 0 10px 0; font-size:14px; letter-spacing:.4px; font-weight:900; color:#cfe7ff}

  /* ===== ì¹´ë“œ ë³¸ì²´ ===== */
  .card{
    position:relative; width:var(--cardW); height:var(--cardH);
    background:var(--card); border:1px solid var(--cardLine); border-radius:22px; overflow:hidden;
    margin:0 auto; padding:16px 16px 200px; text-align:center; color:var(--ink);
    background-repeat:no-repeat; background-position:center; background-size:cover;
    box-shadow:0 16px 40px rgba(0,0,0,.45), 0 0 120px rgba(123,198,255,.15);
  }
  .frame{position:absolute; inset:0; border-radius:22px; pointer-events:none; z-index:10;
    box-shadow:inset 0 0 0 2px rgba(255,255,255,.12), inset 0 0 32px rgba(99,227,255,.08)}
  .frame-img{position:absolute; inset:0; width:100%; height:100%; object-fit:fill; border-radius:22px; pointer-events:none; z-index:11; display:none}

  .badge{
    display:inline-block; padding:10px 16px; border-radius:999px; font-weight:900; letter-spacing:.4px; font-size:24px;
    color:#fff; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.24);
    transform:translateY(var(--badgeY)); /* â† ì„¸ë°€ì¡°ì •: --badgeY */
  }

  /* í”„ë¡œí•„(ì›í˜• í´ë¦¬í•‘ + ë“œë˜ê·¸/ì¤Œ) */
  .pp{
    width:170px; height:170px; border-radius:50%;
    border:4px solid var(--accent);
    margin:6px auto 12px; position:relative; background:#0b111e;
    transform:translateY(var(--ppY)); /* â† ì„¸ë°€ì¡°ì •: --ppY */
    box-shadow:0 0 24px rgba(99,227,255,.18);
  }
  .pp-clip{
    position:absolute; inset:4px; border-radius:50%; overflow:hidden; background:#0d1322;
    touch-action:none; contain:paint; /* ì„±ëŠ¥ ìµœì í™”ìš©(í•„ìš”ì‹œ ì œê±° ê°€ëŠ¥) */
    box-shadow:inset 0 0 24px rgba(0,0,0,.35);
  }
  .pp-clip img{position:absolute; left:0; top:0; width:100%; height:auto; user-select:none; cursor:grab; display:none; image-orientation:from-image}
  .pp-clip .placeholder{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:56px; color:#55627a}

  .name{font-size:var(--nameFont); font-weight:900; margin:4px 0; transform:translateY(var(--nameY))}
  .name .octo-tag{margin-left:8px; font-size:.72em; font-weight:900; letter-spacing:.8px; color:#ff2d55; display:none}
  .rank{font-size:var(--rankFont); font-weight:900; letter-spacing:.8px; display:none; margin-bottom:8px; transform:translateY(var(--rankY))}
  .brand{font-size:var(--brandFont); font-weight:800; margin:6px 0 10px; letter-spacing:.6px; text-transform:uppercase; transform:translateY(var(--brandY))}

  .sockets{display:grid; justify-content:center; gap:10px; margin-top:6px; grid-template-columns:56px; transform:translateY(var(--socketY))}
  .sockets.cols2{grid-template-columns:repeat(2,56px)}
  .sockets.cols3{grid-template-columns:repeat(3,56px)}
  .sockets.cols4{grid-template-columns:repeat(2,56px)}
  .socket{
    width:56px;height:56px;border-radius:12px;background:transparent;border:none;color:rgba(255,255,255,.32);
    display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;outline:1px dashed rgba(255,255,255,.18);
    position:relative;
  }
  .socket img{width:100%;height:100%;object-fit:contain;border-radius:12px}
  .socket.has-img{outline:none}
  .socket::before{
    content:""; position:absolute; left:50%; top:50%; width:48px; height:48px; transform:translate(-50%,-50%);
    border-radius:50%; border:1px solid rgba(255,255,255,.22); box-shadow:0 0 14px rgba(99,227,255,.08) inset;
    pointer-events:none;
  }

  .neon-image-block{margin-top:16px; transform:translateY(var(--neonY))}
  .neon-image-block img{max-width:80%; height:auto; display:block; margin:0 auto}

  .footer-text{position:absolute; bottom:20px; left:0; right:0; font-size:var(--footerFont); font-weight:600; line-height:1.3; text-align:center; color:#fff; opacity:.92; z-index:2; transform:translateY(var(--footerY))}

  /* ===== ì„¸ë°€ ì¡°ì • UI ===== */
  .ctl-row{display:grid; grid-template-columns:var(--labelW) var(--btnW) var(--numW) var(--btnW); align-items:center; gap:8px; margin:8px 0;}
  .ctl-row label{justify-self:end; text-align:right; white-space:nowrap; color:#cfe7ff; font-weight:800; padding-right:4px}
  .num{ width:100%; text-align:center; font-variant-numeric:tabular-nums; padding:8px 10px; border-radius:8px; border:1px solid var(--soft); background:#0f1628; color:#dff1ff; }
  .btn-icon{ width:var(--btnW); height:38px; display:flex; align-items:center; justify-content:center; border-radius:8px; border:1px solid #26324f; background:#0f192c; color:#cfe5ff; font-weight:900; cursor:pointer; }
  .btn-icon:active{transform:translateY(1px)}
  .chip{padding:8px 12px; border-radius:999px; border:1px solid #26324f; background:#0f192c; color:#cfe5ff; font-weight:800; cursor:pointer}
  .chip:active{transform:translateY(1px)}
  .tune-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:980px){ .tune-grid{grid-template-columns:1fr} }
  .fold{border:1px solid var(--line); border-radius:12px; background:#0b1324}
  .fold-head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; cursor:pointer; user-select:none; color:#cfe7ff; font-weight:900; letter-spacing:.2px;}
  .fold-head .caret{transition:transform .2s ease}
  .fold[aria-expanded="true"] .fold-head .caret{transform:rotate(90deg)}
  .fold-body{padding:8px 12px; display:none}
  .fold[aria-expanded="true"] .fold-body{display:block}
</style>
</head>
<body>
<div class="wrap">

  <!-- ìƒë‹¨ íƒ€ì´í‹€/ì €ì¥ -->
  <div class="app-title">
    <h1 class="brandmark">TEAM CHANCE&nbsp;RANK&nbsp;GENERATER</h1>
    <button class="savebtn" id="saveBtn" type="button">ğŸ“¥ ì¹´ë“œ ì €ì¥</button>
  </div>

  <!-- ===== ì™¼ìª½: ì»¨íŠ¸ë¡¤ íŒ¨ë„ ===== -->
  <div class="controls">
    <!-- ê¸°ë³¸/ê³ ê¸‰ íƒ­ -->
    <div class="tabbar" style="display:flex; gap:8px; margin-bottom:12px">
      <button id="cat1Btn" class="savebtn" style="background-image:none;background:#0f192c;color:#cfe5ff;box-shadow:none">ê¸°ë³¸ ì„¤ì •</button>
      <button id="cat2Btn" class="savebtn" style="background-image:none;background:#0f192c;color:#cfe5ff;box-shadow:none;opacity:.9">ê³ ê¸‰ ì„¤ì •</button>
    </div>

    <!-- ê¸°ë³¸ ì„¤ì • -->
    <div id="cat1">
      <!-- ì´ë¦„ -->
      <div class="block">
        <h3>â‘  ì´ë¦„</h3>
        <div class="row">
          <div>
            <label for="nameInput">í‘œì‹œ ì´ë¦„</label>
            <input id="nameInput" type="text" placeholder="ì˜ˆ: ê¹€ ì§„ë˜" />
          </div>
          <div>
            <label for="rankSelect">ë­í¬</label>
            <select id="rankSelect" title="ë­í¬ ì„ íƒ ì‹œ í”„ë ˆì„/ë°°ê²½ ìë™ ë§¤í•‘">
              <option value="">-- RANK --</option>
              <option>CORE 600</option>
              <option>CORE 1250</option>
              <option>CORE 2500</option>
              <option>CORE 5000</option>
            </select>
          </div>
        </div>
        <div class="inline" style="margin-top:8px">
          <label class="nowrap" style="display:flex;align-items:center;gap:8px;margin:0">
            <input id="octoToggle" type="checkbox" />
            <span style="font-size:14px;color:#ff8fa3">ì´ë¦„ì˜† <b style="color:#ff2d55">OCTOPUS</b> í‘œì‹œ</span>
          </label>
        </div>
      </div>

      <!-- í”„ë¡œí•„ -->
      <div class="block">
        <h3>â‘¡ í”„ë¡œí•„</h3>
        <div class="row">
          <div>
            <label>í”„ë¡œí•„ ì‚¬ì§„</label>
            <input id="photoInput" type="file" accept="image/*" />
          </div>
          <div>
            <label>ì´ë¯¸ì§€ ìœ„ì¹˜ ì´ˆê¸°í™”</label>
            <button id="ppReset" class="savebtn" type="button" style="background-image:none;background:#0f192c;color:#cfe5ff;box-shadow:none">ì„¼í„°ë¡œ ë¦¬ì…‹</button>
          </div>
        </div>
        <small style="color:var(--muted)">íœ  í™•ëŒ€/ì¶•ì†Œ Â· ë“œë˜ê·¸ ì´ë™ (ëª¨ë°”ì¼: í•€ì¹˜/ë“œë˜ê·¸)</small>
      </div>

      <!-- ì†Œì¼“ -->
      <div class="block">
        <h3>â‘¢ ì†Œì¼“</h3>
        <div class="row-2auto" style="margin-bottom:8px">
          <div>
            <label>ì†Œì¼“ í”„ë¦¬ì…‹</label>
            <select id="socketPresetSelect">
              <option value="socket-octopusH.png">OCTOPUS H</option>
              <option value="socket-octopusleg.png">OCTOPUS LEG</option>
              <option value="socket-zinrailogo.png" selected>ZiNRAiLOGO (ê¸°ë³¸)</option>
            </select>
          </div>
          <button class="savebtn" id="addSocketPresetBtn" type="button" style="background-image:none;background:#0f192c;color:#cfe5ff">í”„ë¦¬ì…‹ ì¶”ê°€</button>
        </div>

        <div class="row" style="grid-template-columns:1fr 1fr;margin-top:4px">
          <button id="addSocketFile" class="savebtn" type="button" style="background-image:none;background:#0f192c;color:#cfe5ff">íŒŒì¼ë¡œ ì†Œì¼“ ì¶”ê°€</button>
          <button id="removeLast" class="savebtn" type="button" style="background-image:none;background:#1a253d;color:#cfe5ff">ë§ˆì§€ë§‰ ì†Œì¼“ ì‚­ì œ</button>
        </div>
        <span id="socketInfo" style="display:block;margin-top:6px;color:#a7adc0" aria-live="polite">ì†Œì¼“ 0ê°œ</span>
        <input id="socketFile" type="file" accept="image/*" multiple style="display:none" />
      </div>

      <!-- ë„¤ì˜¨ -->
      <div class="block">
        <h3>â‘£ ë„¤ì˜¨ ì´ë¯¸ì§€</h3>
        <div class="row">
          <div>
            <label>ë„¤ì˜¨ í”„ë¦¬ì…‹</label>
            <select id="neonPresetSelect">
              <option value="free-taccyl.png" selected>free-taccyl (ê¸°ë³¸)</option>
              <option value="">ì‚¬ìš© ì•ˆ í•¨</option>
            </select>
          </div>
          <div>
            <label>ë„¤ì˜¨ íŒŒì¼</label>
            <div class="row">
              <button id="neonPickBtn" class="savebtn" type="button" style="background-image:none;background:#0f192c;color:#cfe5ff">íŒŒì¼ ì„ íƒ</button>
              <button id="neonClearBtn" class="savebtn" type="button" style="background-image:none;background:#1a253d;color:#cfe5ff">ë„¤ì˜¨ ì œê±°</button>
            </div>
            <input id="neonFile" type="file" accept="image/*" style="display:none" />
          </div>
        </div>
      </div>
    </div><!-- /cat1 -->

    <!-- ê³ ê¸‰ ì„¤ì • -->
    <div id="cat2" hidden>
      <!-- í”„ë ˆì„/ë°°ê²½ -->
      <div class="block">
        <h3>í”„ë ˆì„ / ë°°ê²½ (ìˆ˜ë™Â·í”„ë¦¬ì…‹)</h3>
        <div class="row">
          <div>
            <label>í”„ë ˆì„ ìˆ˜ë™ ì„¤ì •</label>
            <div class="row">
              <button class="savebtn" id="pickFrameFile" type="button" style="background-image:none;background:#0f192c;color:#cfe5ff">í”„ë ˆì„ ì„ íƒ</button>
              <button class="savebtn" id="clearFrameOverride" type="button" style="background-image:none;background:#1a253d;color:#cfe5ff">ğŸ§¹ í•´ì œ</button>
            </div>
            <input id="frameFileInput" type="file" accept="image/png,image/webp,image/*" style="display:none" />
          </div>
          <div>
            <label>ë°°ê²½ ìˆ˜ë™ ì„¤ì •</label>
            <div class="row">
              <button class="savebtn" id="pickBgFile" type="button" style="background-image:none;background:#0f192c;color:#cfe5ff">ë°°ê²½ ì„ íƒ</button>
              <button class="savebtn" id="clearBgOverride" type="button" style="background-image:none;background:#1a253d;color:#cfe5ff">ğŸ§¹ í•´ì œ</button>
            </div>
            <input id="bgFileInput" type="file" accept="image/*" style="display:none" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>ë°°ê²½ í”„ë¦¬ì…‹</label>
            <select id="bgPresetSelect">
              <option value="">ìë™(ë­í¬ ë§¤í•‘)</option>
              <option value="bg-core-600.png">bg-core-600</option>
              <option value="bg-core-1250.png">bg-core-1250</option>
              <option value="bg-core-2500.png">bg-core-2500</option>
              <option value="bg-core-5000.png">bg-core-5000</option>
            </select>
          </div>
          <div>
            <label>ë°°ê²½ ì±„ìš°ê¸° ë°©ì‹</label>
            <select id="bgFit">
              <option value="cover" selected>ì±„ìš°ê¸° (cover)</option>
              <option value="contain">ë§ì¶¤ (contain)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- ë°°ê²½ ì˜¤ë²„ë ˆì´ -->
      <div class="block">
        <h3>ë°°ê²½ ì˜¤ë²„ë ˆì´</h3>
        <div class="row">
          <div class="inline">
            <input id="cardBgColor" type="color" value="#111522" />
            <small style="color:var(--muted)">ìƒ‰ìƒ</small>
          </div>
          <div class="inline" style="justify-content:space-between">
            <input id="cardBgAlpha" type="range" min="0" max="100" value="100" />
            <small style="color:var(--muted)"><span id="alphaVal">100</span>%</small>
          </div>
        </div>
      </div>

      <!-- ì„¸ë°€ ì¡°ì • -->
      <div class="block">
        <h3>ì„¸ë°€ ì¡°ì •</h3>

        <div class="tune-grid">
          <!-- ìœ„ì¹˜ ì¡°ì •(í† ê¸€) -->
          <section id="fold-pos" class="fold" aria-expanded="false">
            <div class="fold-head" role="button" tabindex="0" aria-controls="fold-pos-body">
              <span>ìœ„ì¹˜ ì¡°ì •</span>
              <span class="caret">â–¶</span>
            </div>
            <div id="fold-pos-body" class="fold-body">
              <div class="ctl-row"><label>ë°°ì§€</label>
                <button class="btn-icon" data-pos="badge" data-op="-">âˆ’</button>
                <input class="num" id="pos-badge-num" type="number" step="1" min="-120" max="120" value="0" />
                <button class="btn-icon" data-pos="badge" data-op="+">+</button>
              </div>
              <div class="ctl-row"><label>í”„ë¡œí•„</label>
                <button class="btn-icon" data-pos="pp" data-op="-">âˆ’</button>
                <input class="num" id="pos-pp-num" type="number" step="1" min="-120" max="120" value="7" />
                <button class="btn-icon" data-pos="pp" data-op="+">+</button>
              </div>
              <div class="ctl-row"><label>ì´ë¦„</label>
                <button class="btn-icon" data-pos="name" data-op="-">âˆ’</button>
                <input class="num" id="pos-name-num" type="number" step="1" min="-120" max="120" value="6" />
                <button class="btn-icon" data-pos="name" data-op="+">+</button>
              </div>
              <div class="ctl-row"><label>íƒ€ì´í‹€</label>
                <button class="btn-icon" data-pos="rank" data-op="-">âˆ’</button>
                <input class="num" id="pos-rank-num" type="number" step="1" min="-120" max="120" value="7" />
                <button class="btn-icon" data-pos="rank" data-op="+">+</button>
              </div>
              <div class="ctl-row"><label>ë¸Œëœë“œ</label>
                <button class="btn-icon" data-pos="brand" data-op="-">âˆ’</button>
                <input class="num" id="pos-brand-num" type="number" step="1" min="-120" max="120" value="11" />
                <button class="btn-icon" data-pos="brand" data-op="+">+</button>
              </div>
              <div class="ctl-row"><label>ì†Œì¼“</label>
                <button class="btn-icon" data-pos="socket" data-op="-">âˆ’</button>
                <input class="num" id="pos-socket-num" type="number" step="1" min="-120" max="120" value="32" />
                <button class="btn-icon" data-pos="socket" data-op="+">+</button>
              </div>
              <div class="ctl-row"><label>ë„¤ì˜¨</label>
                <button class="btn-icon" data-pos="neon" data-op="-">âˆ’</button>
                <input class="num" id="pos-neon-num" type="number" step="1" min="-200" max="200" value="-25" />
                <button class="btn-icon" data-pos="neon" data-op="+">+</button>
              </div>
              <div class="ctl-row"><label>í•˜ë‹¨ë¬¸êµ¬</label>
                <button class="btn-icon" data-pos="footer" data-op="-">âˆ’</button>
                <input class="num" id="pos-footer-num" type="number" step="1" min="-120" max="120" value="-5" />
                <button class="btn-icon" data-pos="footer" data-op="+">+</button>
              </div>
            </div>
          </section>

          <!-- í°íŠ¸ ì¡°ì •(í† ê¸€) -->
          <section id="fold-font" class="fold" aria-expanded="false">
            <div class="fold-head" role="button" tabindex="0" aria-controls="fold-font-body">
              <span>í°íŠ¸ ì¡°ì •</span>
              <span class="caret">â–¶</span>
            </div>
            <div id="fold-font-body" class="fold-body">
              <div class="ctl-row"><label>ì´ë¦„ í°íŠ¸</label>
                <button class="btn-icon" data-font="nameFont" data-op="-">âˆ’</button>
                <input class="num" id="font-nameFont-num" type="number" step="1" min="14" max="48" value="30" />
                <button class="btn-icon" data-font="nameFont" data-op="+">+</button>
              </div>
              <div class="ctl-row"><label>íƒ€ì´í‹€ í°íŠ¸</label>
                <button class="btn-icon" data-font="rankFont" data-op="-">âˆ’</button>
                <input class="num" id="font-rankFont-num" type="number" step="1" min="12" max="40" value="24" />
                <button class="btn-icon" data-font="rankFont" data-op="+">+</button>
              </div>
              <div class="ctl-row"><label>ë¸Œëœë“œ í°íŠ¸</label>
                <button class="btn-icon" data-font="brandFont" data-op="-">âˆ’</button>
                <input class="num" id="font-brandFont-num" type="number" step="1" min="10" max="32" value="18" />
                <button class="btn-icon" data-font="brandFont" data-op="+">+</button>
              </div>
              <div class="ctl-row"><label>í•˜ë‹¨ë¬¸êµ¬ í°íŠ¸</label>
                <button class="btn-icon" data-font="footerFont" data-op="-">âˆ’</button>
                <input class="num" id="font-footerFont-num" type="number" step="1" min="10" max="28" value="14" />
                <button class="btn-icon" data-font="footerFont" data-op="+">+</button>
              </div>
            </div>
          </section>
        </div>

        <div class="inline" style="justify-content:flex-end; gap:8px; margin-top:10px">
          <button id="tuneSave"  class="chip" type="button">ì €ì¥</button>
          <button id="tuneReset" class="chip" type="button">ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div><!-- /cat2 -->
  </div>

  <!-- ===== ì˜¤ë¥¸ìª½: ë¯¸ë¦¬ë³´ê¸° ìº”ë²„ìŠ¤ ===== -->
  <div class="canvas">
    <h2 style="margin:0 0 10px 0; font-size:14px; letter-spacing:.4px; font-weight:800; color:#cfe7ff">ë¯¸ë¦¬ë³´ê¸°</h2>
    <div class="card" id="card" role="img" aria-label="Team Chance ì¹´ë“œ">
      <div class="frame" id="frame"></div>
      <img id="frameImg" class="frame-img" alt="" crossorigin="anonymous" />
      <div class="badge">Congratulations!! ğŸ‰</div>

      <div class="pp" id="ppWrap">
        <div class="pp-clip" id="ppClip">
          <!-- [FIX] í”„ë¡œí•„ì€ ë¡œì»¬/ë°ì´í„°URLì„ ì“°ë¯€ë¡œ crossorigin ì†ì„± ì œê±° -->
          <img id="ppImg" alt="profile" draggable="false" />
          <div class="placeholder" id="ppPlaceholder">ğŸ‘¤</div>
        </div>
      </div>

      <div class="name"><span id="nameText">[ì´ë¦„]</span><span class="octo-tag" id="octoTag">OCTOPUS</span></div>
      <div class="rank" id="rankView"></div>
      <div class="brand">ğŸŒŸ TEAM CHANCE ğŸŒŸ</div>
      <div class="sockets" id="sockets"></div>

      <div class="neon-image-block"><img id="neonImg" alt="neon text" style="display:none" crossorigin="anonymous" /></div>

      <div class="footer-text">Awaken the Movement ğŸŒŠ This is ZiNRAi ğŸ”¥</div>
    </div>
  </div>
</div>

<!-- html2canvas: ì¹´ë“œ ì €ì¥ìš© -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* ============================================================
   ìë°”ìŠ¤í¬ë¦½íŠ¸: ê¸°ëŠ¥ êµ¬í˜„ë¶€
   - [FIX #1] í”„ë¡œí•„ ì´ë¯¸ì§€ëŠ” DataURLë¡œ ë¡œë”©(ì €ì¥ ë°˜ì˜ ì•ˆì •í™”)
   - [FIX #2] ì €ì¥ ì „ ppImgê¹Œì§€ ëª¨ë“  ì´ë¯¸ì§€ ë¡œë“œ ëŒ€ê¸°
   ============================================================ */

const $$=(s)=>document.querySelector(s);
const $all=(s,root=document)=>Array.from(root.querySelectorAll(s));

/* íƒ­ ì „í™˜ */
const cat1Btn=$$('#cat1Btn'), cat2Btn=$$('#cat2Btn'), cat1=$$('#cat1'), cat2=$$('#cat2');
function showCat(n){ if(n===1){cat1.hidden=false;cat2.hidden=true}else{cat1.hidden=true;cat2.hidden=false} }
cat1Btn.addEventListener('click',()=>showCat(1));
cat2Btn.addEventListener('click',()=>showCat(2));

/* ì„¸ë°€ì¡°ì • ì ‘ê¸°/í¼ì¹˜ê¸° */
function bindFold(id){
  const fold = document.getElementById(id);
  if(!fold) return;
  const head = fold.querySelector('.fold-head');
  const toggle = () => {
    const open = fold.getAttribute('aria-expanded') === 'true';
    fold.setAttribute('aria-expanded', String(!open));
  };
  head.addEventListener('click', toggle);
  head.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(); }});
}
bindFold('fold-pos'); bindFold('fold-font');

/* CDN/í”„ë¦¬ì…‹ ë¡œë” */
const COLORS={ "CORE 600":"#bfbfbf", "CORE 1250":"#4caf50", "CORE 2500":"#2196f3", "CORE 5000":"#ffeb3b" };
const CDN_BASES=["https://cdn.jsdelivr.net/gh/kimchance85/Rankcard@master/assets/","https://cdn.jsdelivr.net/gh/kimchance85/Rankcard/assets/"];
const EXT_CANDIDATES=['.png','.webp','.jpg','.jpeg'];
async function loadFirstAvailable(basePathNoExt){
  for (const base of CDN_BASES){
    for (const ext of EXT_CANDIDATES){
      const url=base+basePathNoExt+ext;
      const ok=await new Promise(res=>{const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>res(true); img.onerror=()=>res(false); img.src=url;});
      if(ok) return url;
    }
  }
  throw new Error('No asset: '+basePathNoExt);
}
function stripExt(name){return (name||'').replace(/\.(png|webp|jpg|jpeg)$/i,'');}
const FRAME_BASES={ "CORE 600":"frame-core-600","CORE 1250":"frame-core-1250","CORE 2500":"frame-core-2500","CORE 5000":"frame-core-5000" };
const BG_BASES   ={ "CORE 600":"bg-core-600","CORE 1250":"bg-core-1250","CORE 2500":"bg-core-2500","CORE 5000":"bg-core-5000" };

/* DOM refs */
const card=$$('#card'), frameImg=$$('#frameImg');
const sel=$$('#rankSelect'), nameInput=$$('#nameInput'), nameText=$$('#nameText'), rankView=$$('#rankView');
const ppClip=$$('#ppClip'), ppImg=$$('#ppImg'), ppPlaceholder=$$('#ppPlaceholder'), photoInput=$$('#photoInput'), ppReset=$$('#ppReset');
const cardBgColor=$$('#cardBgColor'), cardBgAlpha=$$('#cardBgAlpha'), alphaVal=$$('#alphaVal'), bgFit=$$('#bgFit');
const neonPickBtn=$$('#neonPickBtn'), neonClearBtn=$$('#neonClearBtn'), neonFile=$$('#neonFile'), neonImg=$$('#neonImg'), neonPresetSelect=$$('#neonPresetSelect');
const socketPresetSelect=$$('#socketPresetSelect'), addSocketPresetBtn=$$('#addSocketPresetBtn');
const socketsWrap=$$('#sockets'), addSocketFileBtn=$$('#addSocketFile'), socketFile=$$('#socketFile'), removeLastBtn=$$('#removeLast'), socketInfo=$$('#socketInfo');
const octoToggle=$$('#octoToggle'), octoTag=$$('#octoTag');
const saveBtn=$$('#saveBtn');

/* ë°°ê²½ ì˜¤ë²„ë ˆì´ */
function hexToRgb(hex){hex=hex.replace('#','');if(hex.length===3)hex=hex.split('').map(h=>h+h).join('');const n=parseInt(hex,16);return{r:(n>>16)&255,g:(n>>8)&255,b:n&255};}
function applyCardBg(){
  if(!cardBgColor||!cardBgAlpha) return;
  const {r,g,b}=hexToRgb(cardBgColor.value); const a=Number(cardBgAlpha.value)/100;
  card.style.backgroundColor=`rgba(${r},${g},${b},${a})`; if(alphaVal) alphaVal.textContent=cardBgAlpha.value;
  const relLum=(0.2126*(r/255)**2.2 + 0.7152*(g/255)**2.2 + 0.0722*(b/255)**2.2) * a;
  card.style.color=(relLum>0.4)?'#111':'#fff';
}
cardBgColor?.addEventListener('input',applyCardBg);
cardBgAlpha?.addEventListener('input',applyCardBg);
bgFit?.addEventListener('change',e=>{ card.style.backgroundSize=e.target.value; });

/* ë­í¬ ì ìš© + í”„ë ˆì„/ë°°ê²½ */
function applyTitle(title){
  if(title){
    const accent=COLORS[title]||"var(--accent)";
    rankView.style.display='block'; rankView.innerHTML=`<span style="color:${accent}">â˜… ${title}</span>`;
    document.querySelector('.pp').style.borderColor=accent;
  }else{
    rankView.style.display='none'; rankView.innerHTML=''; document.querySelector('.pp').style.borderColor='var(--accent)';
  }
}
let frameOverride=null, bgOverride=null, bgPresetOverride="", currentBgUrl="";
async function applyFrameForRank(title){
  if(frameOverride){ frameImg.src=frameOverride; frameImg.style.display='block'; return; }
  const base=FRAME_BASES[title]; if(!base){ frameImg.removeAttribute('src'); frameImg.style.display='none'; return; }
  try{ const url=await loadFirstAvailable(base); frameImg.crossOrigin='anonymous'; frameImg.src=url; frameImg.style.display='block'; }catch{ frameImg.removeAttribute('src'); frameImg.style.display='none'; }
}
async function applyBgForRank(title){
  let url=""; if(bgOverride) url=bgOverride; else if(bgPresetOverride) { try{ url=await loadFirstAvailable(stripExt(bgPresetOverride)); }catch{} }
  if(!url && title && BG_BASES[title]){ try{ url=await loadFirstAvailable(BG_BASES[title]); }catch{} }
  currentBgUrl=url||""; card.style.backgroundImage = url?`url(${url})`:""; card.style.backgroundSize=bgFit?.value||'cover';
}
function updateFrameAndBg(){ const title=sel.value||""; applyTitle(title); applyFrameForRank(title); applyBgForRank(title); }
sel.addEventListener('change',updateFrameAndBg);

/* í”„ë ˆì„/ë°°ê²½ ìˆ˜ë™ */
const pickFrameBtn=$$('#pickFrameFile'), frameFileInput=$$('#frameFileInput'), clearFrameOverrideBtn=$$('#clearFrameOverride');
const pickBgBtn=$$('#pickBgFile'), bgFileInput=$$('#bgFileInput'), clearBgOverrideBtn=$$('#clearBgOverride');
pickFrameBtn?.addEventListener('click',()=>frameFileInput.click());
frameFileInput?.addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=ev=>{ frameOverride=ev.target.result; updateFrameAndBg(); }; r.readAsDataURL(f); e.target.value="";
});
clearFrameOverrideBtn?.addEventListener('click',()=>{ frameOverride=null; updateFrameAndBg(); });
pickBgBtn?.addEventListener('click',()=>bgFileInput.click());
bgFileInput?.addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=ev=>{ bgOverride=ev.target.result; updateFrameAndBg(); }; r.readAsDataURL(f); e.target.value="";
});
clearBgOverrideBtn?.addEventListener('click',()=>{ bgOverride=null; updateFrameAndBg(); });
const bgPresetSelect=$$('#bgPresetSelect'); bgPresetSelect?.addEventListener('change',()=>{ bgPresetOverride=bgPresetSelect.value||""; updateFrameAndBg(); });

/* ë„¤ì˜¨ (ê¸°ë³¸ ON) */
neonPresetSelect?.addEventListener('change', async ()=>{
  const v=neonPresetSelect.value;
  if(v){ try{ const url=await loadFirstAvailable(stripExt(v)); neonImg.crossOrigin='anonymous'; neonImg.src=url; neonImg.style.display='block'; }catch{ neonImg.removeAttribute('src'); neonImg.style.display='none'; alert('ë„¤ì˜¨ í”„ë¦¬ì…‹ ë¡œë“œ ì‹¤íŒ¨'); } }
  else{ neonImg.removeAttribute('src'); neonImg.style.display='none'; }
});
neonPickBtn?.addEventListener('click',()=>neonFile.click());
neonFile?.addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const url=URL.createObjectURL(f); neonImg.src=url; neonImg.style.display='block'; neonImg.onload=()=>URL.revokeObjectURL(url); e.target.value="";
});
neonClearBtn?.addEventListener('click',()=>{ neonImg.removeAttribute('src'); neonImg.style.display='none'; neonPresetSelect.value=""; });

/* ì´ë¦„/OCTO */
nameInput.addEventListener('input',()=>{ nameText.textContent=nameInput.value||"[ì´ë¦„]"; });
octoToggle.addEventListener('change',()=>{ octoTag.style.display=octoToggle.checked?'inline-block':'none'; });

/* ===== í”„ë¡œí•„ ë“œë˜ê·¸/ì¤Œ ì»¨íŠ¸ë¡¤ ===== */
let imgState={naturalW:0,naturalH:0,baseW:0,baseH:0,scale:1,x:0,y:0,dragging:false,startX:0,startY:0,pinch:false,pinchD0:0,scale0:1};
function coverFit(){const cw=ppClip.clientWidth,ch=ppClip.clientHeight,iw=imgState.naturalW,ih=imgState.naturalH;if(!iw||!ih)return;
  if(iw/ih>=cw/ch){imgState.baseH=ch;imgState.baseW=ch*iw/ih;}else{imgState.baseW=cw;imgState.baseH=cw*ih/iw;}
  imgState.scale=1;imgState.x=(cw-imgState.baseW)/2;imgState.y=(ch-imgState.baseH)/2;applyImgStyle();}
function clamp(v,min,max){return Math.min(max,Math.max(min,v));}
function applyImgStyle(){const w=imgState.baseW*imgState.scale,h=imgState.baseH*imgState.scale,cw=ppClip.clientWidth,ch=ppClip.clientHeight;const EPS=0.5;
  const minX=cw-w-EPS,maxX=0+EPS,minY=ch-h-EPS,maxY=0+EPS;imgState.x=(w>=cw)?clamp(imgState.x,minX,maxX):(cw-w)/2;imgState.y=(h>=ch)?clamp(imgState.y,minY,maxY):(ch-h)/2;
  ppImg.style.width=w+'px';ppImg.style.height=h+'px';ppImg.style.left=imgState.x+'px';ppImg.style.top=imgState.y+'px';}
ppClip.addEventListener('wheel',e=>{e.preventDefault();const f=(e.deltaY<0)?1.08:0.92;const old=imgState.scale,neu=clamp(old*f,1,5);
  const r=ppClip.getBoundingClientRect(),cx=e.clientX-r.left,cy=e.clientY-r.top;const w0=imgState.baseW*old,h0=imgState.baseH*old,w1=imgState.baseW*neu,h1=imgState.baseH*neu;
  const dx=(cx-imgState.x)/w0,dy=(cy-imgState.y)/h0;imgState.x=cx-dx*w1;imgState.y=cy-dy*h1;imgState.scale=neu;applyImgStyle();},{passive:false});
ppClip.addEventListener('pointerdown',e=>{if(e.pointerType && !['mouse','pen'].includes(e.pointerType)) return;e.preventDefault();ppClip.setPointerCapture(e.pointerId);imgState.dragging=true;imgState.startX=e.clientX-imgState.x;imgState.startY=e.clientY-imgState.y;});
ppClip.addEventListener('pointermove',e=>{if(e.pointerType && !['mouse','pen'].includes(e.pointerType)) return;if(!imgState.dragging)return;imgState.x=e.clientX-imgState.startX;imgState.y=e.clientY-imgState.startY;applyImgStyle();});
ppClip.addEventListener('pointerup',()=>{imgState.dragging=false;});
ppClip.addEventListener('pointercancel',()=>{imgState.dragging=false;});
function touchDistance(t){const dx=t[0].clientX-t[1].clientX,dy=t[0].clientY-t[1].clientY;return Math.hypot(dx,dy);}
function touchCenter(t){return{x:(t[0].clientX+t[1].clientX)/2,y:(t[0].clientY+t[1].clientY)/2};}
ppClip.addEventListener('touchstart',e=>{if(e.touches.length===1){e.preventDefault();imgState.dragging=true;imgState.startX=e.touches[0].clientX-imgState.x;imgState.startY=e.touches[0].clientY-imgState.y;}
  else if(e.touches.length===2){e.preventDefault();imgState.pinch=true;imgState.pinchD0=touchDistance(e.touches);imgState.scale0=imgState.scale;imgState.center0=touchCenter(e.touches);}}, {passive:false});
ppClip.addEventListener('touchmove',e=>{if(e.touches.length===1&&imgState.dragging){e.preventDefault();imgState.x=e.touches[0].clientX-imgState.startX;imgState.y=e.touches[0].clientY-imgState.startY;applyImgStyle();}
  else if(e.touches.length===2&&imgState.pinch){e.preventDefault();const d=touchDistance(e.touches);let neu=clamp(imgState.scale0*(d/imgState.pinchD0),1,5);
    const r=ppClip.getBoundingClientRect();const cNow=touchCenter(e.touches);const cx=cNow.x-r.left,cy=cNow.y-r.top;const old=imgState.scale,w0=imgState.baseW*old,h0=imgState.baseH*old,w1=imgState.baseW*neu,h1=imgState.baseH*neu;
    const dx=(cx-imgState.x)/w0,dy=(cy-imgState.y)/h0;imgState.x=cx-dx*w1;imgState.y=cy-dy+h1;imgState.scale=neu;applyImgStyle();}}, {passive:false});
ppClip.addEventListener('touchend',e=>{if(e.touches.length===0){imgState.dragging=false;imgState.pinch=false;}if(e.touches.length===1){imgState.pinch=false;}});

/* ì†Œì¼“ */
function updateSocketLayout(){const n=$all('.socket',socketsWrap).length;socketsWrap.classList.remove('cols2','cols3','cols4');
  if(n===2)socketsWrap.classList.add('cols2'); else if(n===3)socketsWrap.classList.add('cols3'); else if(n>=4)socketsWrap.classList.add('cols4');
  socketInfo.textContent=`ì†Œì¼“ ${n}ê°œ`; }
function addSocket(src){const el=document.createElement('div');el.className='socket has-img';const img=document.createElement('img');img.alt='socket';img.crossOrigin='anonymous';img.src=src;
  el.appendChild(img); socketsWrap.appendChild(el); updateSocketLayout();}
addSocketFileBtn?.addEventListener('click',()=>socketFile.click());
socketFile?.addEventListener('change',e=>{(Array.from(e.target.files||[]).filter(f=>f.type.startsWith('image/'))).forEach(file=>{
  const url=URL.createObjectURL(file); addSocket(url); setTimeout(()=>URL.revokeObjectURL(url), 10000);}); e.target.value="";});
removeLastBtn?.addEventListener('click',()=>{const items=$all('.socket',socketsWrap);if(!items.length){alert('ì‚­ì œí•  ì†Œì¼“ì´ ì—†ìŠµë‹ˆë‹¤.');return;}items[items.length-1].remove();updateSocketLayout();});
addSocketPresetBtn?.addEventListener('click', async ()=>{const file=socketPresetSelect.value; if(!file) return; try{ const url=await loadFirstAvailable(stripExt(file)); addSocket(url); }catch{ alert('ì†Œì¼“ í”„ë¦¬ì…‹ ë¡œë“œ ì‹¤íŒ¨'); }});

/* ===== ì €ì¥ (ì¹´ë“œ PNG) ===== */
function waitForImage(el){return new Promise((resolve)=>{if(!el||!el.src||el.style.display==='none') return resolve(); if(el.complete && el.naturalWidth>0) return resolve(); el.addEventListener('load',resolve,{once:true}); el.addEventListener('error',resolve,{once:true});});}
function preloadUrl(url){return new Promise((resolve)=>{if(!url) return resolve(); const img=new Image(); img.crossOrigin='anonymous'; img.onload=resolve; img.onerror=resolve; img.src=url;});}
async function ensureAssetsReady(){
  // [FIX #2] ì €ì¥ ì „ì— í”„ë¡œí•„(ppImg)ë„ ë°˜ë“œì‹œ ëŒ€ê¸° â†’ ì €ì¥ ê²°ê³¼ì— ë¹ ì§€ì§€ ì•Šê²Œ ë³´ì¥
  const socketImgs=$all('.socket img',socketsWrap);
  await Promise.all([ waitForImage(ppImg), waitForImage(frameImg), waitForImage(neonImg), preloadUrl(currentBgUrl), ...socketImgs.map(waitForImage) ]);
}
function sanitizeFileName(s){return (s||'').normalize('NFKD').replace(/[^\w.-]+/g,'_').replace(/^_+|_+$/g,'');}
async function saveCard(){try{
  await ensureAssetsReady();
  await new Promise(r=>requestAnimationFrame(r));
  const canvas=await html2canvas(card,{
    backgroundColor:null, scale:3, scrollX:0, scrollY:0, useCORS:true,
    imageTimeout:15000 /* ì´ë¯¸ì§€ ëŠë¦´ ë•Œ ëŒ€ê¸° ì‹œê°„ ì—°ì¥ */
  });
  const a=document.createElement('a'); const t=sel.value?`_${sel.value}`:''; const n=sanitizeFileName(nameText.textContent||'card'); a.download=`${n}${t}.png`; a.href=canvas.toDataURL(); a.click();
}catch(err){console.error(err); alert('ì¹´ë“œ ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');}}
saveBtn.addEventListener('click',saveCard);

/* ===== ì„¸ë°€ ì¡°ì • (ìœ„ì¹˜/í°íŠ¸ â†” CSS ë³€ìˆ˜) ===== */
const TUNE_KEY='tcrg_tuning_v1';
const posIds=['badge','pp','name','rank','brand','socket','neon','footer'];
const fontIds=['nameFont','rankFont','brandFont','footerFont'];
const posNumEls=Object.fromEntries(posIds.map(id=>[id,$$('#pos-'+id+'-num')]));
const fontNumEls=Object.fromEntries(fontIds.map(id=>[id,$$('#font-'+id+'-num')]));
function clampToInput(input,val){const min=Number(input.min??-1e6),max=Number(input.max??1e6); return Math.min(max,Math.max(min,val));}
function setPos(id, px){if(!Number.isFinite(px))return;px=Math.round(px);document.documentElement.style.setProperty('--'+id+'Y', px+'px'); if(posNumEls[id]) posNumEls[id].value=String(px);}
function setFontVar(id, px){if(!Number.isFinite(px))return;px=Math.max(px,6)|0;document.documentElement.style.setProperty('--'+id, px+'px'); if(fontNumEls[id]) fontNumEls[id].value=String(px);}
document.addEventListener('click',(e)=>{
  const t=e.target.closest('.btn-icon'); if(!t) return;
  if(t.dataset.pos){const id=t.dataset.pos; const input=posNumEls[id]; if(!input) return; const cur=Number(input.value||0); const next=t.dataset.op==='+'?cur-1:cur+1; setPos(id, clampToInput(input,next));}
  if(t.dataset.font){const id=t.dataset.font; const input=fontNumEls[id]; if(!input) return; const cur=Number(input.value||0); const next=t.dataset.op==='+'?cur+1:cur-1; setFontVar(id, clampToInput(input,next));}
});
Object.entries(posNumEls).forEach(([id,el])=>{el?.addEventListener('input',()=>{ setPos(id, clampToInput(el, Number(el.value||0))); });});
Object.entries(fontNumEls).forEach(([id,el])=>{el?.addEventListener('input',()=>{ setFontVar(id, clampToInput(el, Number(el.value||0))); });});
function readTuningFromUI(){const pos={}, font={}; Object.entries(posNumEls).forEach(([k,el])=>{ if(el) pos[k]=Number(el.value||0) }); Object.entries(fontNumEls).forEach(([k,el])=>{ if(el) font[k]=Number(el.value||0) }); const overlay = cardBgColor && cardBgAlpha ? { color: cardBgColor.value, alpha: Number(cardBgAlpha.value||100) } : null; const size = bgFit ? { fit: bgFit.value } : null; return {pos,font,overlay,size};}
function applyTuning(t){if(!t)return; if(t.pos)Object.entries(t.pos).forEach(([k,v])=>setPos(k,Number(v))); if(t.font)Object.entries(t.font).forEach(([k,v])=>setFontVar(k,Number(v))); if(t.overlay && cardBgColor && cardBgAlpha){ cardBgColor.value=t.overlay.color||cardBgColor.value; cardBgAlpha.value=String(t.overlay.alpha ?? cardBgAlpha.value); applyCardBg(); } if(t.size && bgFit && t.size.fit){ bgFit.value=t.size.fit; card.style.backgroundSize=t.size.fit; }}
function saveTuning(){ try{ localStorage.setItem(TUNE_KEY, JSON.stringify(readTuningFromUI())); alert('ì„¸ë°€ ì¡°ì • ì €ì¥ ì™„ë£Œ'); }catch{} }
function resetTuningToDefault(){ Object.entries(posNumEls).forEach(([k,el])=>{ if(el) setPos(k, Number(el.defaultValue||0)); }); Object.entries(fontNumEls).forEach(([k,el])=>{ if(el) setFontVar(k, Number(el.defaultValue||0)); }); if(cardBgColor && cardBgAlpha){ cardBgColor.value="#111522"; cardBgAlpha.value="100"; applyCardBg(); } if(bgFit){ bgFit.value="cover"; card.style.backgroundSize="cover"; } try{ localStorage.removeItem(TUNE_KEY); }catch{} alert('ì„¸ë°€ ì¡°ì • ì´ˆê¸°í™” ì™„ë£Œ'); }
document.getElementById('tuneSave')?.addEventListener('click', saveTuning);
document.getElementById('tuneReset')?.addEventListener('click', resetTuningToDefault);

/* ===== [FIX #1] í”„ë¡œí•„ ì—…ë¡œë“œ: DataURLë¡œ ë¡œë“œ =====
   - FileReader â†’ dataURL ë¡œ ì½ìœ¼ë©´ html2canvasê°€ í™•ì‹¤íˆ ìº”ë²„ìŠ¤ì— í¬í•¨ì‹œí‚µë‹ˆë‹¤.
   - ê°™ì€ íŒŒì¼ ì¬ì„ íƒì„ í—ˆìš©í•˜ê¸° ìœ„í•´ input.value ëŠ” ì¦‰ì‹œ ë¹„ì›ë‹ˆë‹¤. */
photoInput?.addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  photoInput.value = ""; // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ í—ˆìš©

  if(!f){
    ppImg.style.display='none'; ppImg.removeAttribute('src'); ppPlaceholder.style.display='flex';
    return;
  }
  if(f.type && !f.type.startsWith('image/')){ alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆì–´ìš”.'); return; }

  try{
    // íŒŒì¼ â†’ DataURL(base64)
    const dataURL = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(f); });

    // ë¡œë“œ & í‘œì‹œ
    ppImg.src = dataURL;                 // [FIX] blobURL ëŒ€ì‹  DataURL ì‚¬ìš©
    try{ if(ppImg.decode) await ppImg.decode(); }catch{}
    await new Promise((res)=>{ if(ppImg.complete && ppImg.naturalWidth>0) return res(); ppImg.onload=()=>res(); });

    ppImg.style.display='block'; ppPlaceholder.style.display='none';
    imgState.naturalW = ppImg.naturalWidth; imgState.naturalH = ppImg.naturalHeight;
    coverFit();
  }catch(err){
    console.error('[PP] load failed:', err);
    ppImg.style.display='none'; ppImg.removeAttribute('src'); ppPlaceholder.style.display='flex';
    alert('í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. JPG/PNG/WebPë¡œ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
  }
});
ppReset.addEventListener('click',()=>{ if(ppImg.src) coverFit(); });

/* ===== ì´ˆê¸°í™” ===== */
(async function init(){
  showCat(1);
  applyCardBg();
  card.style.backgroundImage=''; card.style.backgroundSize=bgFit?.value || 'cover';
  octoTag.style.display='none'; nameText.textContent='[ì´ë¦„]';
  applyTitle(""); updateFrameAndBg();

  // ë„¤ì˜¨ ê¸°ë³¸ í”„ë¦¬ì…‹
  if(neonPresetSelect){ neonPresetSelect.value='free-taccyl.png'; neonPresetSelect.dispatchEvent(new Event('change')); }

  // ê¸°ë³¸ ì†Œì¼“ 1ê°œ(ZiNRAiLOGO)
  try{
    if($all('.socket',socketsWrap).length===0){
      const url=await loadFirstAvailable(stripExt('socket-zinrailogo.png')); addSocket(url);
    }
  }catch{}

  // ì„¸ë°€ì¡°ì • ì…ë ¥ê°’ â†’ CSS ë³€ìˆ˜ ë°˜ì˜
  Object.entries(posNumEls).forEach(([k,el])=>{ if(el) setPos(k, Number(el.value||0)); });
  Object.entries(fontNumEls).forEach(([k,el])=>{ if(el) setFontVar(k, Number(el.value||0)); });

  // ì €ì¥ê°’ì´ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê¸°
  try{ const raw=localStorage.getItem(TUNE_KEY); if(raw){ applyTuning(JSON.parse(raw)); } }catch{}
})();
</script>
</body>
</html>
