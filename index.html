<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TEAM CHANCE ì¹´ë“œ (ì„¸ë¡œí˜• â€¢ ëª¨ë“ ê¸°ëŠ¥ â€¢ ìœ„ì¹˜/í°íŠ¸ì¡°ì ˆ â€¢ ë‹¤ì¤‘ í…œí”Œë¦¿ â€¢ ìµœì¢… â€¢ Â±ë¯¸ì„¸ì¡°ì •)</title>

<style>
  :root{
    /* ================= ì¹´ë“œ ë¹„ìœ¨/í¬ê¸° ================= */
    --cardH: 720px;
    --ratio: 1.5858;
    --cardW: calc(var(--cardH) / var(--ratio));

    /* ================= ê³µí†µ ìƒ‰ìƒ ================= */
    --bg:#0f1118; --panel:#171923; --line:#262b3a; --soft:#2a3145;
    --ink:#fff; --muted:#a7adc0; --card:#111522; --cardLine:#28314a;
    --accent:#6aa8ff; --octo-red:#ff2d55;

    /* ================= ìš”ì†Œ ìœ„ì¹˜(px) ================= */
    --badgeY: 0px;
    --ppY: 0px;
    --nameY: 0px;
    --rankY: 0px;
    --brandY: 0px;
    --socketY: 0px;
    --neonY: 0px;
    --footerY: 0px;

    /* ================= í°íŠ¸ í¬ê¸°(px) ================= */
    --nameFont: 30px;
    --rankFont: 24px;
    --brandFont: 18px;
    --footerFont: 14px;
  }

  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg);
    font-family:system-ui,-apple-system,"Noto Sans KR",Segoe UI,Roboto,sans-serif;
    color:var(--ink);
    display:flex; align-items:center; justify-content:center;
    min-height:100vh; padding:14px;
  }
  .wrap{width:var(--cardW); max-width:var(--cardW)}

  /* ============== ì»¨íŠ¸ë¡¤ íŒ¨ë„ ============== */
  .controls{
    background:var(--panel); border:1px solid var(--line); border-radius:16px;
    padding:12px; margin-bottom:12px;
  }
  .controls label{display:block; font-size:13px; color:var(--muted); margin-top:6px}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .row-3{display:grid; grid-template-columns:auto 1fr auto auto; gap:6px; align-items:center}
  .row-2auto{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
  .row-1{display:grid; grid-template-columns:1fr; gap:8px}
  .inline{display:flex; align-items:center; gap:8px}
  .mono{font-variant-numeric:tabular-nums; font-feature-settings:"tnum"}
  .controls input,.controls select,.controls button{
    width:100%; margin-top:6px; background:#10131b; color:#fff;
    border:1px solid var(--soft); border-radius:8px; padding:6px 10px; font-size:14px
  }
  .controls input[type="number"]{text-align:center}
  .btn{cursor:pointer}

  /* ============== ì¹´ë“œ ë³¸ì²´ ============== */
  .card{
    position:relative; width:var(--cardW); height:var(--cardH);
    background:var(--card); border:1px solid var(--cardLine); border-radius:22px;
    padding:16px 16px 200px; /* í•˜ë‹¨ ê³ ì •ë¬¸êµ¬ì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì—¬ë°± */
    text-align:center; box-shadow:0 10px 28px rgba(0,0,0,.35);
    overflow:hidden; margin:0 auto;
    background-repeat:no-repeat; background-position:center; background-size:cover;
    color:var(--ink);
  }

  /* í”„ë ˆì„ ë ˆì´ì–´ */
  .frame{
    position:absolute; inset:0; border-radius:22px; pointer-events:none; z-index:10;
    box-shadow:inset 0 0 0 2px rgba(255,255,255,.18);
  }
  .frame-img{
    position:absolute; inset:0; width:100%; height:100%;
    object-fit:fill; border-radius:22px; pointer-events:none; z-index:11; display:none;
  }

  /* ë°°ì§€ */
  .badge{
    display:inline-block; padding:12px 18px; border-radius:999px; font-weight:800; letter-spacing:.4px;
    border:1px solid rgba(255,255,255,.28);
    margin-top:10px; margin-bottom:25px; font-size:28px;
    background:rgba(0,0,0,.18);
    transform:translateY(var(--badgeY));
  }

  /* í”„ë¡œí•„(ì›í˜•) */
  .pp{
    width:170px; height:170px; border-radius:50%; overflow:hidden;
    border:4px solid var(--accent);
    margin:4px auto 12px;
    position:relative; background:#1a1c24; touch-action:none;
    transform:translateY(var(--ppY));
  }
  .pp img{
    position:absolute; left:0; top:0; width:100%; height:auto;
    user-select:none; cursor:grab; display:none; image-orientation:from-image;
  }
  .placeholder{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:56px; color:#555
  }

  /* í…ìŠ¤íŠ¸ ë¸”ë¡ë“¤ */
  .name{
    font-size:var(--nameFont); font-weight:800; margin:4px 0;
    transform:translateY(var(--nameY))
  }
  .name .octo-tag{
    margin-left:8px; font-size:.72em; font-weight:900; letter-spacing:.8px; color:var(--octo-red); display:none
  }
  .rank{
    font-size:var(--rankFont); font-weight:900; letter-spacing:.8px; display:none; margin-bottom:8px;
    transform:translateY(var(--rankY))
  }
  .brand{
    font-size:var(--brandFont); font-weight:800; margin:6px 0 10px; letter-spacing:.6px; text-transform:uppercase;
    transform:translateY(var(--brandY))
  }

  /* ì†Œì¼“ */
  .sockets{
    display:grid; justify-content:center; gap:10px; margin-top:6px;
    grid-template-columns:56px; transform:translateY(var(--socketY));
  }
  .sockets.cols2{grid-template-columns:repeat(2,56px)}
  .sockets.cols3{grid-template-columns:repeat(3,56px)}
  .sockets.cols4{grid-template-columns:repeat(2,56px)} /* 4ê°œ ì´ìƒ 2ì—´ */

  .socket{
    width:56px; height:56px; border-radius:12px; background:transparent; border:none;
    color:rgba(255,255,255,.32); display:flex; align-items:center; justify-content:center;
    font-size:22px; cursor:pointer; outline:1px dashed rgba(255,255,255,.18);
  }
  .socket img{width:100%; height:100%; object-fit:contain; border-radius:12px}
  .socket.has-img{outline:none}

  /* ë„¤ì˜¨ ì´ë¯¸ì§€ */
  .neon-image-block{margin-top:16px; transform:translateY(var(--neonY))}
  .neon-image-block img{max-width:80%; height:auto; display:block; margin:0 auto}

  /* í•˜ë‹¨ ê³ ì • ë¬¸êµ¬ */
  .footer-text{
    position:absolute; bottom:20px; left:0; right:0;
    font-size:var(--footerFont); font-weight:600; line-height:1.3; text-align:center; color:var(--ink); opacity:.9; z-index:2;
    transform:translateY(var(--footerY));
  }

  /* ì €ì¥ ë²„íŠ¼ */
  .savebtn{
    margin-top:12px; width:100%; padding:12px; border:none; border-radius:12px;
    background:#3b82f6; color:#fff; font-size:16px; font-weight:700; cursor:pointer
  }

  /* ìœ„ì¹˜/í°íŠ¸ ì¡°ì ˆ ë²„íŠ¼ ê·¸ë£¹ */
  .pos-grid{display:grid; grid-template-columns:1fr 92px 44px 44px 56px; gap:6px; align-items:center}
  .pos-grid small{color:#a7adc0}
  .btn-square{padding:6px 0; text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <!-- ===================== ì»¨íŠ¸ë¡¤ íŒ¨ë„ ===================== -->
  <div class="controls">
    <!-- ì´ë¦„ / íƒ€ì´í‹€ -->
    <label>ì´ë¦„ / ë‹‰ë„¤ì„</label>
    <input id="nameInput" type="text" placeholder="ì˜ˆ) CHANCE KIM" />

    <label>íƒ€ì´í‹€ (ë¯¸ì„ íƒ ì‹œ ì¹´ë“œì—ì„œ ìˆ¨ê¹€)</label>
    <select id="rankSelect">
      <option value="">-- ì„ íƒ ì•ˆ í•¨ --</option>
      <option>CORE 600</option>
      <option>CORE 1250</option>
      <option>CORE 2500</option>
      <option>CORE 5000</option>
    </select>

    <!-- í”„ë¡œí•„ -->
    <div class="row">
      <div>
        <label>í”„ë¡œí•„ ì‚¬ì§„</label>
        <input id="photoInput" type="file" accept="image/*" />
      </div>
      <div>
        <label>í”„ë¡œí•„ ì´ë¯¸ì§€ ì´ˆê¸°í™”</label>
        <button id="ppReset" class="btn" type="button">ì„¼í„°ë¡œ ë¦¬ì…‹</button>
      </div>
    </div>

    <!-- ë°°ê²½: ìƒ‰/íˆ¬ëª…ë„/ë§ì¶¤/ì´ë¯¸ì§€ -->
    <label style="margin-top:8px">ì¹´ë“œ ë°°ê²½</label>
    <div class="row">
      <div class="inline">
        <input id="cardBgColor" type="color" value="#111522" />
        <small>ë°°ê²½ìƒ‰</small>
      </div>
      <div class="inline" style="justify-content:space-between">
        <input id="cardBgAlpha" type="range" min="0" max="100" value="100" />
        <small class="mono"><span id="alphaVal">100</span>%</small>
      </div>
    </div>
    <div class="row">
      <select id="bgFit">
        <option value="cover">ì±„ìš°ê¸°</option>
        <option value="contain">ë§ì¶¤</option>
      </select>
      <button id="cardBgImageBtn" class="btn" type="button">ğŸ–¼ï¸ ë°°ê²½ ì´ë¯¸ì§€ ì„ íƒ</button>
    </div>
    <button id="cardBgImageClear" class="btn" type="button" style="margin-top:6px">ğŸ§¹ ë°°ê²½ ì´ë¯¸ì§€ ì œê±°</button>
    <input id="cardBgFile" type="file" accept="image/*" style="display:none" />

    <!-- OCTOPUS íƒœê·¸ -->
    <label style="display:flex;align-items:center;gap:8px;margin-top:8px">
      <input id="octoToggle" type="checkbox" />
      <span style="font-size:14px;color:#ff8fa3">ì´ë¦„ ì˜†ì— <b style="color:#ff2d55">OCTOPUS</b> í‘œì‹œ</span>
    </label>

    <!-- ì†Œì¼“(íŒŒì¼ ì¶”ê°€/ì‚­ì œ) -->
    <div class="row" style="grid-template-columns:1fr 1fr">
      <button id="addSocketFile" class="btn" type="button">ğŸ§© íŒŒì¼ë¡œ ì†Œì¼“ ì¶”ê°€</button>
      <button id="removeLast" class="btn" type="button">ğŸ—‘ï¸ ë§ˆì§€ë§‰ ì†Œì¼“ ì‚­ì œ</button>
    </div>
    <span id="socketInfo" style="display:block;margin-top:6px;color:#a7adc0">ì†Œì¼“ 0ê°œ</span>
    <input id="socketFile" type="file" accept="image/*" multiple style="display:none" />

    <!-- íƒ€ì´í‹€ í”„ë ˆì„ PNG ì €ì¥/ì ìš©(ë¡œì»¬ ì €ì¥) -->
    <label style="margin-top:10px">íƒ€ì´í‹€ë³„ í”„ë ˆì„ PNG ì—…ë¡œë“œ(ë‚´ì¥ ì €ì¥)</label>
    <div class="row">
      <button class="btn" type="button" onclick="pickFrame('CORE 600')">ğŸ“¥ CORE 600</button>
      <button class="btn" type="button" onclick="pickFrame('CORE 1250')">ğŸ“¥ CORE 1250</button>
    </div>
    <div class="row">
      <button class="btn" type="button" onclick="pickFrame('CORE 2500')">ğŸ“¥ CORE 2500</button>
      <button class="btn" type="button" onclick="pickFrame('CORE 5000')">ğŸ“¥ CORE 5000</button>
    </div>
    <input id="frameFile" type="file" accept="image/png,image/webp" style="display:none" />
    <button id="clearCurrentFrame" class="btn" type="button" style="margin-top:6px">ğŸ§¹ í˜„ì¬ íƒ€ì´í‹€ í”„ë ˆì„ ì œê±°</button>

    <!-- ë„¤ì˜¨ ë¬¸êµ¬ ì´ë¯¸ì§€ -->
    <label style="margin-top:10px">ë„¤ì˜¨ ë¬¸êµ¬ ì´ë¯¸ì§€</label>
    <div class="row">
      <button id="neonPickBtn" class="btn" type="button">âœ¨ ë„¤ì˜¨ ì´ë¯¸ì§€ ì„ íƒ</button>
      <button id="neonClearBtn" class="btn" type="button">ğŸ§¹ ë„¤ì˜¨ ì´ë¯¸ì§€ ì œê±°</button>
    </div>
    <input id="neonFile" type="file" accept="image/*" style="display:none" />

    <!-- ============ ìš”ì†Œ ìœ„ì¹˜ ì¡°ì ˆ (Â± / ìˆ«ì ì…ë ¥) ============ -->
    <label style="margin-top:10px">ìš”ì†Œ ìœ„ì¹˜ ì¡°ì ˆ (ìƒí•˜ ì´ë™, px)</label>
    <div class="pos-grid">
      <small>ë°°ì§€</small>
      <input id="pos-badge" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('badge',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('badge',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('badge')">0</button>
    </div>
    <div class="pos-grid">
      <small>í”„ë¡œí•„</small>
      <input id="pos-pp" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('pp',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('pp',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('pp')">0</button>
    </div>
    <div class="pos-grid">
      <small>ì´ë¦„</small>
      <input id="pos-name" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('name',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('name',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('name')">0</button>
    </div>
    <div class="pos-grid">
      <small>íƒ€ì´í‹€</small>
      <input id="pos-rank" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('rank',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('rank',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('rank')">0</button>
    </div>
    <div class="pos-grid">
      <small>ë¸Œëœë“œ</small>
      <input id="pos-brand" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('brand',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('brand',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('brand')">0</button>
    </div>
    <div class="pos-grid">
      <small>ì†Œì¼“</small>
      <input id="pos-socket" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('socket',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('socket',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('socket')">0</button>
    </div>
    <div class="pos-grid">
      <small>ë„¤ì˜¨</small>
      <input id="pos-neon" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('neon',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('neon',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('neon')">0</button>
    </div>
    <div class="pos-grid">
      <small>í•˜ë‹¨ë¬¸êµ¬</small>
      <input id="pos-footer" type="number" value="0" />
      <button class="btn btn-square" type="button" onclick="adjPos('footer',-1)">-</button>
      <button class="btn btn-square" type="button" onclick="adjPos('footer',1)">+</button>
      <button class="btn" type="button" onclick="zeroPos('footer')">0</button>
    </div>

    <!-- ============ í°íŠ¸ í¬ê¸°(ìˆ«ì ì…ë ¥ + Â±) ============ -->
    <label style="margin-top:10px">í°íŠ¸ í¬ê¸° (px)</label>
    <div class="row-3"><small>ì´ë¦„</small><input type="number" id="nameFont" value="30"/><button class="btn" type="button" onclick="adjFont('nameFont',1)">+</button><button class="btn" type="button" onclick="adjFont('nameFont',-1)">-</button></div>
    <div class="row-3"><small>íƒ€ì´í‹€</small><input type="number" id="rankFont" value="24"/><button class="btn" type="button" onclick="adjFont('rankFont',1)">+</button><button class="btn" type="button" onclick="adjFont('rankFont',-1)">-</button></div>
    <div class="row-3"><small>ë¸Œëœë“œ</small><input type="number" id="brandFont" value="18"/><button class="btn" type="button" onclick="adjFont('brandFont',1)">+</button><button class="btn" type="button" onclick="adjFont('brandFont',-1)">-</button></div>
    <div class="row-3"><small>í•˜ë‹¨ë¬¸êµ¬</small><input type="number" id="footerFont" value="14"/><button class="btn" type="button" onclick="adjFont('footerFont',1)">+</button><button class="btn" type="button" onclick="adjFont('footerFont',-1)">-</button></div>

    <!-- ============ ë‹¤ì¤‘ í…œí”Œë¦¿ ============ -->
    <label style="margin-top:10px">í…œí”Œë¦¿</label>
    <div class="row">
      <input id="tplName" placeholder="í…œí”Œë¦¿ ì´ë¦„ (ì˜ˆ: ê¸°ë³¸, ì˜¥í† ë²„ì „ ë“±)"/>
      <label class="inline" style="margin-top:0"><input type="checkbox" id="tplIncludeImages" /> ì´ë¯¸ì§€ í¬í•¨ ì €ì¥</label>
    </div>
    <div class="row">
      <button id="tplSaveAs" class="btn" type="button">ğŸ’¾ ì €ì¥(ìƒˆ ì´ë¦„)</button>
      <button id="tplUpdate" class="btn" type="button">ğŸ“ ë®ì–´ì“°ê¸°</button>
    </div>
    <div class="row">
      <select id="tplSelect"></select>
      <button id="tplLoad" class="btn" type="button">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
    <div class="row">
      <button id="tplDelete" class="btn" type="button">ğŸ—‘ï¸ ì‚­ì œ</button>
      <button id="tplExport" class="btn" type="button">â¬‡ï¸ ë‚´ë³´ë‚´ê¸°(JSON)</button>
    </div>
    <div class="row">
      <input id="tplImportFile" type="file" accept="application/json" />
      <button id="tplImport" class="btn" type="button">â¬†ï¸ ê°€ì ¸ì˜¤ê¸°(JSON)</button>
    </div>
  </div>

  <!-- ===================== ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸° ===================== -->
  <div class="card" id="card" role="img" aria-label="Team Chance ì¹´ë“œ">
    <div class="frame" id="frame"></div>
    <img id="frameImg" class="frame-img" alt="" />

    <div class="badge">Congratulations!! ğŸ‰</div>

    <div class="pp" id="ppWrap">
      <img id="ppImg" alt="profile" />
      <div class="placeholder" id="ppPlaceholder">ğŸ‘¤</div>
    </div>

    <div class="name">
      <span id="nameText">[ì´ë¦„]</span>
      <span class="octo-tag" id="octoTag">OCTOPUS</span>
    </div>

    <div class="rank" id="rankView"></div>

    <div class="brand">ğŸŒŸ TEAM CHANCE ğŸŒŸ</div>

    <div class="sockets" id="sockets"></div>

    <!-- ê³µë°± ì˜ì—­ ë„¤ì˜¨ ì´ë¯¸ì§€ -->
    <div class="neon-image-block"><img id="neonImg" alt="neon text" style="display:none" /></div>

    <div class="footer-text">Awaken the Movement ğŸŒŠ This is ZiNRAi ğŸ”¥</div>
  </div>

  <button class="savebtn" id="saveBtn" type="button">ğŸ“¥ ì¹´ë“œ PNGë¡œ ì €ì¥</button>
</div>

<!-- DOM â†’ PNG ì €ì¥ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
/* =========================================================
   ìœ í‹¸/ì„ íƒì
========================================================= */
const $$=(s)=>document.querySelector(s);
const $all=(s,root=document)=>Array.from(root.querySelectorAll(s));

/* íƒ€ì´í‹€ ìƒ‰ìƒ */
const COLORS={ "CORE 600":"#bfbfbf", "CORE 1250":"#4caf50", "CORE 2500":"#2196f3", "CORE 5000":"#ffeb3b" };

/* DOM ìºì‹œ */
const card=$$('#card'), frame=$$('#frame'), frameImg=$$('#frameImg');
const sel=$$('#rankSelect'), nameInput=$$('#nameInput'), nameText=$$('#nameText'), rankView=$$('#rankView');
const ppWrap=$$('#ppWrap'), ppImg=$$('#ppImg'), ppPlaceholder=$$('#ppPlaceholder'), photoInput=$$('#photoInput'), ppReset=$$('#ppReset');

const cardBgColor=$$('#cardBgColor'), cardBgAlpha=$$('#cardBgAlpha'), alphaVal=$$('#alphaVal'), bgFit=$$('#bgFit');
const cardBgImageBtn=$$('#cardBgImageBtn'), cardBgImageClear=$$('#cardBgImageClear'), cardBgFile=$$('#cardBgFile');

const octoToggle=$$('#octoToggle'), octoTag=$$('#octoTag');

const socketsWrap=$$('#sockets'), addSocketFileBtn=$$('#addSocketFile'), socketFile=$$('#socketFile'), removeLastBtn=$$('#removeLast');
const socketInfo=$$('#socketInfo'), saveBtn=$$('#saveBtn');

const frameFile=$$('#frameFile'), clearBtn=$$('#clearCurrentFrame');

const neonPickBtn=$$('#neonPickBtn'), neonClearBtn=$$('#neonClearBtn'), neonFile=$$('#neonFile'), neonImg=$$('#neonImg');

/* ìœ„ì¹˜ ì…ë ¥ DOM (ìŠ¬ë¼ì´ë” ì œê±°, ìˆ«ì + Â± ë°©ì‹) */
const posIds=['badge','pp','name','rank','brand','socket','neon','footer'];
const posInputs=Object.fromEntries(posIds.map(id=>[id,$$('#pos-'+id)]));

/* í°íŠ¸ ì…ë ¥ DOM */
const fontIds=['nameFont','rankFont','brandFont','footerFont'];
const fontInputs=Object.fromEntries(fontIds.map(id=>[id,$$('#'+id)]));

/* =========================================================
   ë°°ê²½: ìƒ‰/íˆ¬ëª…ë„/ì´ë¯¸ì§€/ë§ì¶¤ + ê°€ë…ì„± ë³´ì •
========================================================= */
function hexToRgb(hex){hex=hex.replace('#','');if(hex.length===3)hex=hex.split('').map(h=>h+h).join('');const n=parseInt(hex,16);return{r:(n>>16)&255,g:(n>>8)&255,b:n&255};}
function applyCardBg(){
  const {r,g,b}=hexToRgb(cardBgColor.value);
  const a=Number(cardBgAlpha.value)/100;
  card.style.backgroundColor=`rgba(${r},${g},${b},${a})`;
  alphaVal.textContent=cardBgAlpha.value;

  /* ê°„ë‹¨ íœ˜ë„ ì¶”ì •ìœ¼ë¡œ í…ìŠ¤íŠ¸ ì»¬ëŸ¬ ë°˜ì „(ë°ìœ¼ë©´ ì–´ë‘¡ê²Œ) */
  const relLum=(0.2126*(r/255)**2.2 + 0.7152*(g/255)**2.2 + 0.0722*(b/255)**2.2) * a;
  card.style.color=(relLum>0.4)?'#111':'#fff';
}
cardBgColor.addEventListener('input',applyCardBg);
cardBgAlpha.addEventListener('input',applyCardBg);
bgFit.addEventListener('change',e=>{ card.style.backgroundSize=e.target.value; });
cardBgImageBtn.onclick=()=>cardBgFile.click();
cardBgFile.addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ card.style.backgroundImage=`url(${ev.target.result})`; card.style.backgroundSize=bgFit.value; };
  r.readAsDataURL(f); cardBgFile.value="";
});
cardBgImageClear.onclick=()=>{ card.style.backgroundImage=''; };

/* =========================================================
   íƒ€ì´í‹€ í”„ë ˆì„ ì €ì¥/ì ìš© (localStorage)
========================================================= */
function frameKey(title){return'frame_'+title;}
function getFrame(title){return localStorage.getItem(frameKey(title))||"";}
function setFrame(title,dataUrl){localStorage.setItem(frameKey(title),dataUrl);}
function clearFrame(title){localStorage.removeItem(frameKey(title));}

let currentFrameTitle="";
function pickFrame(title){currentFrameTitle=title; frameFile.click(); }
frameFile.addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    setFrame(currentFrameTitle, ev.target.result);
    alert(currentFrameTitle+" í”„ë ˆì„ ì €ì¥ ì™„ë£Œ");
    if(sel.value===currentFrameTitle) applyTitle(sel.value);
  };
  reader.readAsDataURL(f);
  frameFile.value="";
});
clearBtn.addEventListener('click',()=>{
  if(!sel.value){ alert('ë¨¼ì € íƒ€ì´í‹€ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  clearFrame(sel.value); applyTitle(sel.value);
});

function applyTitle(title){
  if(title){
    rankView.style.display='block';
    const accent=COLORS[title]||"#6aa8ff";
    rankView.innerHTML=`<span style="color:${accent}">â˜… ${title}</span>`;
    document.querySelector('.pp').style.borderColor=accent;
  }else{
    rankView.style.display='none'; rankView.innerHTML='';
    document.querySelector('.pp').style.borderColor='var(--accent)';
  }
  /* í”„ë ˆì„ ë ˆì´ì–´ */
  const data=getFrame(title);
  if(data){ frame.style.boxShadow='none'; frameImg.src=data; frameImg.style.display='block'; }
  else { frameImg.removeAttribute('src'); frameImg.style.display='none'; frame.style.boxShadow='inset 0 0 0 2px rgba(255,255,255,.18)'; }
}
sel.addEventListener('change',()=>applyTitle(sel.value));

/* =========================================================
   ì´ë¦„ / OCTOPUS
========================================================= */
nameInput.addEventListener('input',()=>{ nameText.textContent=nameInput.value||"[ì´ë¦„]"; });
octoToggle.addEventListener('change',()=>{ octoTag.style.display=octoToggle.checked?'inline-block':'none'; });

/* =========================================================
   í”„ë¡œí•„: cover-fit + ì œìŠ¤ì²˜
========================================================= */
let imgState={naturalW:0,naturalH:0,baseW:0,baseH:0,scale:1,x:0,y:0,dragging:false,startX:0,startY:0,pinch:false,pinchD0:0,scale0:1};

function coverFit(){
  const cw=ppWrap.clientWidth, ch=ppWrap.clientHeight, iw=imgState.naturalW, ih=imgState.naturalH;
  if(!iw||!ih) return;
  if(iw/ih>=cw/ch){ imgState.baseH=ch; imgState.baseW=ch*iw/ih; }
  else{ imgState.baseW=cw; imgState.baseH=cw*ih/iw; }
  imgState.scale=1; imgState.x=(cw-imgState.baseW)/2; imgState.y=(ch-imgState.baseH)/2; applyImgStyle();
}
function clamp(v,min,max){return Math.min(max,Math.max(min,v));}
function applyImgStyle(){
  const w=imgState.baseW*imgState.scale, h=imgState.baseH*imgState.scale;
  const cw=ppWrap.clientWidth, ch=ppWrap.clientHeight;
  const minX=cw-w, maxX=0, minY=ch-h, maxY=0;
  imgState.x=(w>=cw)?clamp(imgState.x,minX,maxX):(cw-w)/2;
  imgState.y=(h>=ch)?clamp(imgState.y,minY,maxY):(ch-h)/2;
  ppImg.style.width=w+'px'; ppImg.style.height=h+'px';
  ppImg.style.left=imgState.x+'px'; ppImg.style.top=imgState.y+'px';
}
/* íœ  ì¤Œ(ë°ìŠ¤í¬íƒ‘) */
ppWrap.addEventListener('wheel', e=>{
  e.preventDefault();
  const factor=(e.deltaY<0)?1.08:0.92;
  const old=imgState.scale, neu=clamp(old*factor,1,5);
  const rect=ppWrap.getBoundingClientRect(), cx=e.clientX-rect.left, cy=e.clientY-rect.top;
  const w0=imgState.baseW*old, h0=imgState.baseH*old, w1=imgState.baseW*neu, h1=imgState.baseH*neu;
  const dx=(cx-imgState.x)/w0, dy=(cy-imgState.y)/h0;
  imgState.x=cx-dx*w1; imgState.y=cy-dy*h1; imgState.scale=neu; applyImgStyle();
},{passive:false});
/* ë“œë˜ê·¸(ë°ìŠ¤í¬íƒ‘) */
ppWrap.addEventListener('pointerdown', e=>{
  if(e.pointerType && e.pointerType!=='mouse') return;
  e.preventDefault(); ppWrap.setPointerCapture(e.pointerId);
  imgState.dragging=true; imgState.startX=e.clientX-imgState.x; imgState.startY=e.clientY-imgState.y;
});
ppWrap.addEventListener('pointermove', e=>{
  if(e.pointerType && e.pointerType!=='mouse') return;
  if(!imgState.dragging) return;
  imgState.x=e.clientX-imgState.startX; imgState.y=e.clientY-imgState.startY; applyImgStyle();
});
ppWrap.addEventListener('pointerup',   e=>{ if(e.pointerType && e.pointerType!=='mouse') return; imgState.dragging=false; });
ppWrap.addEventListener('pointercancel',e=>{ if(e.pointerType && e.pointerType!=='mouse') return; imgState.dragging=false; });
/* ëª¨ë°”ì¼: í•œì† ë“œë˜ê·¸ + ë‘ì† í•€ì¹˜ì¤Œ */
function touchDistance(t){const dx=t[0].clientX-t[1].clientX, dy=t[0].clientY-t[1].clientY; return Math.hypot(dx,dy);}
function touchCenter(t){return{x:(t[0].clientX+t[1].clientX)/2,y:(t[0].clientY+t[1].clientY)/2};}
ppWrap.addEventListener('touchstart', e=>{
  if(e.touches.length===1){
    e.preventDefault(); imgState.dragging=true;
    imgState.startX=e.touches[0].clientX-imgState.x; imgState.startY=e.touches[0].clientY-imgState.y;
  }else if(e.touches.length===2){
    e.preventDefault(); imgState.pinch=true; imgState.pinchD0=touchDistance(e.touches); imgState.scale0=imgState.scale; imgState.center0=touchCenter(e.touches);
  }
},{passive:false});
ppWrap.addEventListener('touchmove', e=>{
  if(e.touches.length===1 && imgState.dragging){
    e.preventDefault(); imgState.x=e.touches[0].clientX-imgState.startX; imgState.y=e.touches[0].clientY-imgState.startY; applyImgStyle();
  }else if(e.touches.length===2 && imgState.pinch){
    e.preventDefault();
    const d=touchDistance(e.touches); let neu=clamp(imgState.scale0*(d/imgState.pinchD0),1,5);
    const rect=ppWrap.getBoundingClientRect();
    const cNow=touchCenter(e.touches); const cx=cNow.x-rect.left, cy=cNow.y-rect.top;
    const old=imgState.scale, w0=imgState.baseW*old, h0=imgState.baseH*old, w1=imgState.baseW*neu, h1=imgState.baseH*neu;
    const dx=(cx-imgState.x)/w0, dy=(cy-imgState.y)/h0;
    imgState.x=cx-dx*w1; imgState.y=cy-dy*h1; imgState.scale=neu; applyImgStyle();
  }
},{passive:false});
ppWrap.addEventListener('touchend', e=>{
  if(e.touches.length===0){ imgState.dragging=false; imgState.pinch=false; }
  if(e.touches.length===1){ imgState.pinch=false; }
});
/* ì—…ë¡œë“œ â†’ coverFit */
photoInput.addEventListener('change',e=>{
  const f=e.target.files?.[0];
  if(!f){ ppImg.style.display='none'; ppImg.src=''; ppPlaceholder.style.display='flex'; return; }
  const r=new FileReader();
  r.onload=ev=>{
    ppImg.src=ev.target.result;
    ppImg.onload=()=>{ ppImg.style.display='block'; ppPlaceholder.style.display='none';
      imgState.naturalW=ppImg.naturalWidth; imgState.naturalH=ppImg.naturalHeight; coverFit(); };
  };
  r.readAsDataURL(f);
});
ppReset.addEventListener('click',()=>{ if(ppImg.src) coverFit(); });

/* =========================================================
   ì†Œì¼“: íŒŒì¼ ì¶”ê°€/ì‚­ì œ + ë ˆì´ì•„ì›ƒ ìë™
========================================================= */
function updateSocketLayout(){
  const n=$all('.socket',socketsWrap).length;
  socketsWrap.classList.remove('cols2','cols3','cols4');
  if(n===2) socketsWrap.classList.add('cols2');
  else if(n===3) socketsWrap.classList.add('cols3');
  else if(n>=4) socketsWrap.classList.add('cols4');
  socketInfo.textContent=`ì†Œì¼“ ${n}ê°œ`;
}
function addSocket(src){
  const el=document.createElement('div');
  el.className='socket has-img';
  el.innerHTML=`<img src="${src}" alt="socket">`;
  socketsWrap.appendChild(el);
  updateSocketLayout();
}
addSocketFileBtn.addEventListener('click',()=>socketFile.click());
socketFile.addEventListener('change',e=>{
  const files=Array.from(e.target.files||[]).filter(f=>f.type.startsWith('image/'));
  if(!files.length) return;
  files.forEach(file=>{
    const reader=new FileReader();
    reader.onload=ev=>addSocket(ev.target.result);
    reader.readAsDataURL(file);
  });
  socketFile.value="";
});
removeLastBtn.addEventListener('click',()=>{
  const items=$all('.socket',socketsWrap);
  if(!items.length){ alert('ì‚­ì œí•  ì†Œì¼“ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  items[items.length-1].remove();
  updateSocketLayout();
});

/* =========================================================
   ë„¤ì˜¨ ì´ë¯¸ì§€(ê³µë°± ì˜ì—­)
========================================================= */
neonPickBtn.addEventListener('click',()=>neonFile.click());
neonFile.addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ neonImg.src=ev.target.result; neonImg.style.display='block'; };
  r.readAsDataURL(f); neonFile.value="";
});
neonClearBtn.addEventListener('click',()=>{ neonImg.removeAttribute('src'); neonImg.style.display='none'; });

/* =========================================================
   PNG ì €ì¥
========================================================= */
async function saveCard(){
  await new Promise(r=>requestAnimationFrame(r));
  const canvas=await html2canvas(card,{backgroundColor:null,scale:3,scrollX:0,scrollY:0,useCORS:true});
  const a=document.createElement('a');
  const t=sel.value?`_${sel.value}`:''; const n=(nameText.textContent||'card').replace(/\s+/g,'_');
  a.download=`${n}${t}.png`; a.href=canvas.toDataURL(); a.click();
}
saveBtn.addEventListener('click',saveCard);

/* =========================================================
   ìœ„ì¹˜ ì¡°ì ˆ (Â± / ìˆ«ì ì…ë ¥)  â˜… ìŠ¬ë¼ì´ë” ì‚­ì œ ë²„ì „
========================================================= */
function setPos(id, px){
  if(!Number.isFinite(px)) return;
  px = Math.round(px);
  document.documentElement.style.setProperty('--'+id+'Y', px+'px');
  posInputs[id].value = px;
}
function adjPos(id, delta){
  const v=parseInt(posInputs[id].value||'0',10) || 0;
  setPos(id, v+delta);
}
function zeroPos(id){ setPos(id, 0); }
/* ìˆ«ì ì…ë ¥ â†’ ì¦‰ì‹œ ë°˜ì˜ */
posIds.forEach(id=>{
  posInputs[id].addEventListener('input', ()=>{
    const v=parseInt(posInputs[id].value||'0',10) || 0;
    setPos(id, v);
  });
});

/* =========================================================
   í°íŠ¸ í¬ê¸° â€” ìˆ«ì ì…ë ¥ + Â± ë²„íŠ¼
========================================================= */
function setFontVar(id,px){
  if(!Number.isFinite(px)) return;
  if(px<6) px=6;
  document.documentElement.style.setProperty('--'+id, px+'px');
  fontInputs[id].value = px;
}
function adjFont(id,delta){
  const v=parseInt(fontInputs[id].value||0)||0;
  setFontVar(id, v+delta);
}
/* ì…ë ¥ì°½ ì§ì ‘ ì…ë ¥ ë°˜ì˜ */
fontIds.forEach(id=>{
  fontInputs[id].addEventListener('input',()=>{
    const v=parseInt(fontInputs[id].value||0)||0;
    setFontVar(id, v);
  });
});

/* =========================================================
   ë‹¤ì¤‘ í…œí”Œë¦¿ ê´€ë¦¬ (localStorage.cardTemplates)
========================================================= */
const tplName=$$('#tplName'), tplIncludeImages=$$('#tplIncludeImages');
const tplSaveAs=$$('#tplSaveAs'), tplUpdate=$$('#tplUpdate');
const tplSelect=$$('#tplSelect'), tplLoad=$$('#tplLoad');
const tplDelete=$$('#tplDelete'), tplExport=$$('#tplExport');
const tplImportFile=$$('#tplImportFile'), tplImport=$$('#tplImport');

function getTemplates(){
  try{ return JSON.parse(localStorage.getItem('cardTemplates')||'{}'); }catch(e){ return {}; }
}
function setTemplates(obj){
  localStorage.setItem('cardTemplates', JSON.stringify(obj));
}
function refreshTplSelect(){
  const tpls=getTemplates();
  const names=Object.keys(tpls).sort();
  tplSelect.innerHTML=names.length? names.map(n=>`<option>${n}</option>`).join('') : '<option value="">(ì €ì¥ëœ í…œí”Œë¦¿ ì—†ìŒ)</option>';
}

/* í˜„ì¬ UI ìƒíƒœ â†’ TemplateObject */
function collectTemplate(includeImages){
  const positions=Object.fromEntries(posIds.map(id=>[id+'Y', String(parseInt(posInputs[id].value||'0',10)||0)]));
  const fonts=Object.fromEntries(fontIds.map(fid=>[fid, String(parseInt(fontInputs[fid].value||'0',10)||0)]));
  const tpl={
    name: tplName.value.trim() || '',
    title: sel.value || '',
    octo: !!octoToggle.checked,
    nameText: nameInput.value || '',
    bgColor: cardBgColor.value,
    bgAlpha: String(cardBgAlpha.value),
    bgFit: bgFit.value,
    positions, fonts
  };

  if(includeImages){
    /* ë°°ê²½ ì´ë¯¸ì§€ dataURL ì¶”ì¶œ */
    const bg = getComputedStyle(card).backgroundImage;
    const m = bg && bg.startsWith('url(') ? bg.match(/^url\("(.*)"\)$/) : null;
    if(m && m[1] && m[1].startsWith('data:')) tpl.bgImage = m[1];

    /* ì†Œì¼“ ì´ë¯¸ì§€ë“¤ */
    const sockets = $all('.socket img',socketsWrap).map(img=>img.src).filter(Boolean);
    if(sockets.length) tpl.sockets = sockets;

    /* ë„¤ì˜¨ ì´ë¯¸ì§€ */
    if(neonImg && neonImg.src) tpl.neon = neonImg.src;
  }
  return tpl;
}

/* TemplateObject â†’ UI ë°˜ì˜ */
function applyTemplate(tpl){
  /* í…ìŠ¤íŠ¸/íƒ€ì´í‹€/íƒœê·¸ */
  nameInput.value = tpl.nameText || '';
  nameText.textContent = tpl.nameText || '[ì´ë¦„]';
  sel.value = tpl.title || '';
  applyTitle(sel.value);
  octoToggle.checked = !!tpl.octo;
  octoTag.style.display = tpl.octo ? 'inline-block' : 'none';

  /* ë°°ê²½ */
  cardBgColor.value = tpl.bgColor || '#111522';
  cardBgAlpha.value = tpl.bgAlpha || '100';
  applyCardBg();
  bgFit.value = tpl.bgFit || 'cover';
  card.style.backgroundSize = bgFit.value;

  /* ë°°ê²½ ì´ë¯¸ì§€ ë³µì› */
  card.style.backgroundImage = '';
  if(tpl.bgImage){ card.style.backgroundImage = `url(${tpl.bgImage})`; }

  /* ìœ„ì¹˜ ê°’ ë°˜ì˜ */
  if(tpl.positions){
    posIds.forEach(id=>{
      const v = parseInt(tpl.positions[id+'Y'] ?? '0',10) || 0;
      setPos(id, v);
    });
  }else{
    posIds.forEach(id=>setPos(id,0));
  }

  /* í°íŠ¸ í¬ê¸° */
  if(tpl.fonts){
    fontIds.forEach(fid=>{
      const v = parseInt(tpl.fonts[fid]||0,10) || parseInt(getComputedStyle(document.documentElement).getPropertyValue('--'+fid)) || 12;
      setFontVar(fid, v);
    });
  }

  /* ì†Œì¼“/ë„¤ì˜¨ (ì´ë¯¸ì§€ í¬í•¨ ì €ì¥ ì‹œ) */
  $all('.socket',socketsWrap).forEach(n=>n.remove());
  if(Array.isArray(tpl.sockets)){ tpl.sockets.forEach(src=>addSocket(src)); }
  if(tpl.neon){ neonImg.src = tpl.neon; neonImg.style.display = 'block'; } else { neonImg.removeAttribute('src'); neonImg.style.display='none'; }
}

/* í…œí”Œë¦¿ ì €ì¥(ìƒˆ ì´ë¦„) */
tplSaveAs.addEventListener('click',()=>{
  const name = (tplName.value||'').trim();
  if(!name){ alert('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const includeImages = tplIncludeImages.checked;
  const tpls=getTemplates();
  if(tpls[name] && !confirm('ê°™ì€ ì´ë¦„ì˜ í…œí”Œë¦¿ì´ ìˆìŠµë‹ˆë‹¤. ë®ì–´ì“¸ê¹Œìš”?')) return;
  tpls[name] = collectTemplate(includeImages);
  tpls[name].name = name;
  setTemplates(tpls);
  refreshTplSelect();
  alert('í…œí”Œë¦¿ ì €ì¥ ì™„ë£Œ!');
});

/* í˜„ì¬ ì„ íƒ í…œí”Œë¦¿ì— ë®ì–´ì“°ê¸° */
tplUpdate.addEventListener('click',()=>{
  const selName = tplSelect.value;
  if(!selName){ alert('ì™¼ìª½ ë“œë¡­ë‹¤ìš´ì—ì„œ í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  const includeImages = tplIncludeImages.checked;
  const tpls=getTemplates();
  tpls[selName] = collectTemplate(includeImages);
  tpls[selName].name = selName;
  setTemplates(tpls);
  alert('ë®ì–´ì“°ê¸° ì™„ë£Œ!');
});

/* ë¶ˆëŸ¬ì˜¤ê¸° */
tplLoad.addEventListener('click',()=>{
  const selName = tplSelect.value;
  if(!selName){ alert('ë¶ˆëŸ¬ì˜¬ í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  const tpls=getTemplates();
  const tpl = tpls[selName];
  if(!tpl){ alert('í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
  tplName.value = tpl.name || selName;
  applyTemplate(tpl);
});

/* ì‚­ì œ */
tplDelete.addEventListener('click',()=>{
  const selName = tplSelect.value;
  if(!selName){ alert('ì‚­ì œí•  í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  if(!confirm(`í…œí”Œë¦¿ "${selName}"ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?`)) return;
  const tpls=getTemplates();
  delete tpls[selName];
  setTemplates(tpls);
  refreshTplSelect();
  alert('ì‚­ì œ ì™„ë£Œ');
});

/* ë‚´ë³´ë‚´ê¸°(JSON) */
tplExport.addEventListener('click',()=>{
  const tpls=getTemplates();
  const blob=new Blob([JSON.stringify(tpls,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download='cardTemplates.json'; a.click();
  URL.revokeObjectURL(url);
});

/* ê°€ì ¸ì˜¤ê¸°(JSON) â€” ë³‘í•© ì €ì¥ */
tplImport.addEventListener('click',()=>{
  const f=tplImportFile.files?.[0];
  if(!f){ alert('JSON íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const incoming=JSON.parse(ev.target.result);
      const base=getTemplates();
      const merged={...base, ...incoming};
      setTemplates(merged);
      refreshTplSelect();
      alert('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!');
    }catch(err){ alert('JSON íŒŒì‹± ì‹¤íŒ¨: '+err.message); }
  };
  r.readAsText(f);
});

/* =========================================================
   ì´ˆê¸°í™”
========================================================= */
(function init(){
  applyCardBg();
  card.style.backgroundImage='';
  card.style.backgroundSize=bgFit.value;
  octoTag.style.display='none';
  nameText.textContent='[ì´ë¦„]';
  applyTitle("");

  /* ìœ„ì¹˜ ì…ë ¥ ì´ˆê¸°ê°’ ë°˜ì˜ */
  posIds.forEach(id=>{
    const v=parseInt(posInputs[id].value||'0',10)||0;
    setPos(id, v);
  });

  /* í°íŠ¸ ì…ë ¥ê°’ â†’ CSS ë³€ìˆ˜ ë™ê¸°í™” */
  fontIds.forEach(fid=>{
    const v=parseInt(fontInputs[fid].value||0)||0;
    setFontVar(fid, v);
  });

  /* í…œí”Œë¦¿ ëª©ë¡ ë¡œë”© */
  refreshTplSelect();
})();
</script>
</body>
</html>